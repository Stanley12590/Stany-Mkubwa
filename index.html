<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STANY MIN TV</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <!-- Video Player -->
    <link href="https://unpkg.com/video.js@7.21.1/dist/video-js.min.css" rel="stylesheet">
    <link href="https://unpkg.com/videojs-contrib-drm@5.0.0/dist/videojs-contrib-drm.min.css" rel="stylesheet">
    <script src="https://unpkg.com/video.js@7.21.1/dist/video.min.js"></script>
    <script src="https://unpkg.com/@videojs/http-streaming@2.14.2/dist/videojs-http-streaming.min.js"></script>
    <script src="https://unpkg.com/videojs-contrib-drm@5.0.0/dist/videojs-contrib-drm.min.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff0000; /* RED */
            --secondary: #000000; /* BLACK */
            --tertiary: #ffffff; /* WHITE */
            --bg: #0a0a0f;
            --card: #1a1a2e;
            --text: #e0e0e0;
            --success: #4caf50;
            --error: #ff0000;
            --warning: #ff9800;
            --info: #2196f3;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Montserrat', sans-serif; 
            user-select: none; 
            -webkit-user-select: none; 
        }

        body {
            background: linear-gradient(135deg, #000000, #151525);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-bottom: 70px;
        }

        /* iOS 26 Style Glassmorphism */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Rounded corners */
        .rounded-lg { border-radius: 15px; }
        .rounded-xl { border-radius: 20px; }

        /* Loader / Splash Screen */
        #loader { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: var(--secondary); 
            z-index: 9999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
            transition: opacity 0.5s ease;
        }
        
        .splash-logo {
            font-family: 'Orbitron';
            font-size: 2.5em;
            color: var(--primary);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        .spinner { 
            width: 50px; height: 50px; 
            border: 4px solid rgba(255, 255, 255, 0.1); 
            border-top: 4px solid var(--primary); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Ad Modal */
        .ad-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 350px;
            height: 500px;
            background: var(--card);
            border-radius: 20px;
            z-index: 10000;
            display: none;
            overflow: hidden;
            border: 3px solid var(--primary);
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
        }

        .ad-content { height: 100%; display: flex; flex-direction: column; }

        /* Marquee/Scrolling Text */
        .marquee-top, .marquee-bottom {
            background: rgba(0, 0, 0, 0.8);
            color: var(--primary);
            padding: 10px;
            font-weight: bold;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            font-size: 0.9em;
        }

        .marquee-text { display: inline-block; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Ad Media Area */
        .ad-media { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .ad-media img, .ad-media video { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Social Media Icons Grid */
        .social-icons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
        }

        .social-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--tertiary);
            text-decoration: none;
            font-size: 0.8em;
        }

        .social-icon:hover { background: var(--primary); transform: scale(1.05); }
        .social-icon i { font-size: 1.5em; margin-bottom: 5px; }

        /* Ad Controls */
        .ad-controls { padding: 15px; background: rgba(0, 0, 0, 0.9); display: flex; justify-content: space-between; align-items: center; }
        .ad-timer { color: var(--primary); font-weight: bold; font-size: 1.2em; }
        .skip-btn { background: var(--primary); color: var(--tertiary); border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: none; }
        .skip-btn.active { display: block; }

        /* Premium Token Modal */
        .token-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 400px;
            background: var(--card);
            border-radius: 20px;
            z-index: 10001;
            display: none;
            padding: 25px;
            border: 2px solid var(--primary);
        }

        /* Standard UI */
        .auth-screen { 
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: var(--bg); z-index: 2000; 
            display: flex; justify-content: center; 
            align-items: center; flex-direction: column; 
        }
        .auth-card { 
            width: 90%; max-width: 400px; 
            background: var(--card); padding: 30px; 
            border-radius: 20px; border: 1px solid var(--primary); 
            text-align: center; 
        }
        .input-box { 
            width: 100%; padding: 12px; 
            margin-bottom: 15px; background: #0f1015; 
            border: 1px solid #333; color: var(--tertiary); 
            border-radius: 10px; outline: none; 
        }
        .btn { 
            width: 100%; padding: 12px; 
            background: linear-gradient(45deg, var(--primary), #cc0000); 
            border: none; color: var(--tertiary); 
            font-weight: bold; border-radius: 10px; 
            cursor: pointer; margin-top: 10px; 
        }

        /* Cards Grid */
        .grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 15px; padding: 0 15px 20px; 
        }
        
        @media (max-width: 480px) {
            .grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
        }
        
        .card { 
            background: var(--card); border-radius: 15px; 
            overflow: hidden; border: 1px solid #333; 
            position: relative; aspect-ratio: 2/3;
            transition: transform 0.2s;
        }
        .card:hover { transform: scale(1.05); }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            padding: 10px; text-align: center; 
            background: rgba(0,0,0,0.8);
            font-size: 0.9em; font-weight: bold;
        }
        .card-info h4 { 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            font-size: 1.1em; font-weight: 700;
        }

        /* Carousel */
        .carousel {
            width: 95%; height: 220px;
            overflow: hidden; position: relative;
            margin: 15px auto 20px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
        }
        .carousel-slide {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0; transition: opacity 0.8s ease;
            border-radius: 20px; overflow: hidden;
        }
        .carousel-slide.active { opacity: 1; }
        .carousel-slide img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-caption {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 15px 20px; color: var(--tertiary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .carousel-title {
            font-size: 1.4em; font-weight: bold;
            margin-bottom: 5px; color: var(--primary);
            font-family: 'Orbitron';
        }
        .carousel-description { font-size: 1em; color: #e0e0e0; line-height: 1.4; }

        /* Header & Navigation */
        .header { 
            padding: 15px; background: var(--card); 
            border-bottom: 1px solid #333; 
            display: flex; justify-content: space-between; 
            align-items: center; position: sticky; 
            top: 0; z-index: 100; 
        }
        .logo { 
            font-family: 'Orbitron'; color: var(--primary); 
            font-size: 1.4em; font-weight: bold; 
        }
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--card); border-top: 1px solid #333; 
            display: flex; justify-content: space-around; 
            padding: 10px 0; z-index: 1000; 
        }
        .nav-item { 
            color: #888; text-align: center; font-size: 0.8em; 
            text-decoration: none; font-weight: bold; 
            position: relative; cursor: pointer;
        }
        .nav-item i { font-size: 1.5em; margin-bottom: 3px; display: block; }
        .nav-item.active { color: var(--primary); }

        /* Chat Header */
        .chat-header { padding: 15px; background: var(--card); border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
        .back-arrow { color: var(--primary); font-size: 1.5em; cursor: pointer; }
        .chat-title { color: var(--primary); font-size: 1.2em; font-weight: bold; }

        /* Modals */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.95); 
            z-index: 7000; justify-content: center; align-items: center; 
        }
        .modal-box { 
            background: var(--card); width: 90%; max-width: 400px; 
            padding: 25px; border-radius: 20px; 
            border: 1px solid var(--primary); position: relative; 
            text-align: center; 
        }
        .close-modal { 
            position: absolute; top: 15px; right: 15px; 
            color: var(--tertiary); font-size: 24px; cursor: pointer; 
        }
        
        /* Utilities */
        .page { display: none; } .page.active { display: block; }
        .section-title { 
            margin: 20px 15px 10px; font-family: 'Orbitron'; 
            color: var(--primary); border-left: 4px solid var(--primary); 
            padding-left: 10px; font-size: 1.3em; font-weight: bold;
        }
        
        /* TOAST NOTIFICATIONS */
        #toast { 
            position: fixed; bottom: 80px; right: 20px; 
            padding: 15px 20px; border-radius: 8px; 
            transform: translateX(200%); transition: transform 0.3s ease; 
            z-index: 9000; font-weight: bold;
            display: flex; align-items: center; gap: 10px;
            min-width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 90%; word-wrap: break-word;
        }
        
        .toast-success { background: #4caf50; color: var(--tertiary); border-left: 4px solid #2e7d32; }
        .toast-error { background: var(--error); color: var(--tertiary); border-left: 4px solid #cc0000; }
        .toast-warning { background: var(--warning); color: var(--secondary); border-left: 4px solid #ef6c00; }
        .toast-info { background: var(--info); color: var(--tertiary); border-left: 4px solid #1565c0; }
        .toast-premium { background: linear-gradient(45deg, #FFD700, #FFA000); color: var(--secondary); border-left: 4px solid #FF6F00; }
        .toast-chat { background: linear-gradient(45deg, var(--primary), #cc0000); color: var(--tertiary); border-left: 4px solid #990000; }
        
        /* Device Overlay */
        #deviceOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0f; z-index: 8000; display: none;
            flex-direction: column; justify-content: center; 
            align-items: center; text-align: center; padding: 20px;
        }

        /* WhatsApp Float */
        .whatsapp-float {
            position: fixed; bottom: 80px; right: 20px;
            background: #25D366; color: var(--tertiary);
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8em; cursor: pointer; z-index: 999;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            animation: float 3s ease-in-out infinite;
            display: none;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Age Gate Modal */
        .age-gate, .more-menu-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10002;
            display: none; justify-content: center; align-items: center;
        }

        .age-content, .more-menu-content {
            background: var(--card); padding: 30px;
            border-radius: 20px; border: 3px solid var(--primary);
            text-align: center; max-width: 400px; width: 90%;
        }

        .age-warning { color: var(--primary); font-size: 2em; margin-bottom: 20px; }
        .age-buttons, .more-menu-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .age-btn, .more-menu-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; min-width: 120px; }
        .age-confirm, .more-menu-btn { background: var(--primary); color: var(--tertiary); }
        .age-exit { background: #333; color: var(--tertiary); }

        /* More Menu Items */
        .more-menu-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px; background: rgba(255,255,255,0.05);
            border-radius: 10px; margin-bottom: 10px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .more-menu-item:hover { background: rgba(255,0,0,0.2); }
        .more-menu-item i { font-size: 1.5em; color: var(--primary); width: 30px; }
        .more-menu-item span { color: var(--tertiary); font-weight: bold; flex: 1; text-align: left; }

        /* Locked/Expired Overlay */
        .locked-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center;
            z-index: 10; border-radius: 15px;
        }
        .lock-icon { font-size: 2em; color: var(--primary); text-shadow: 0 0 10px rgba(255,0,0,0.5); animation: pulse 2s infinite; }

        /* Search Bar */
        .search-container { display: flex; align-items: center; gap: 10px; }
        .search-input {
            width: 0; padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary); border-radius: 20px;
            color: var(--tertiary); outline: none;
            transition: width 0.3s ease; opacity: 0;
        }
        .search-input.active { width: 200px; opacity: 1; }
        .search-icon { color: var(--primary); cursor: pointer; font-size: 1.2em; }

        /* Favorites Star */
        .favorite-star {
            position: absolute; top: 10px; right: 10px;
            color: #FFD700; font-size: 1.5em; z-index: 5;
            cursor: pointer; text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        /* Story/Simulizi Page Styles */
        .story-container {
            padding: 20px;
            background: var(--card);
            border-radius: 20px;
            margin: 15px;
            position: relative;
            overflow: hidden;
        }

        .story-drop-image {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.3; filter: blur(10px);
            z-index: 1;
        }

        .story-content {
            position: relative; z-index: 2;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 15px;
        }

        .story-title {
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 10px;
            font-family: 'Orbitron';
        }

        .story-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            color: #aaa;
        }

        .story-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .story-meta-item i {
            color: var(--primary);
        }

        .story-about {
            margin-bottom: 25px;
            line-height: 1.6;
            color: var(--tertiary);
        }

        .story-parts {
            margin-top: 20px;
        }

        .part-content {
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .part-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .part-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: var(--tertiary);
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .part-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .part-info {
            text-align: center;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Tech Updates Page */
        .tech-update-card {
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
            border: 1px solid var(--primary);
        }

        .tech-update-title {
            color: var(--primary);
            font-size: 1.3em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .tech-update-date {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tech-update-content {
            color: var(--tertiary);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .tech-update-category {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(255,0,0,0.2);
            color: var(--primary);
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Betting Tips Card */
        .betting-tip-card {
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
            border: 1px solid var(--primary);
            position: relative;
        }

        .tip-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .tip-status {
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-success { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-failed { background: rgba(255, 0, 0, 0.2); color: #ff0000; }
        .status-pending { background: rgba(255, 152, 0, 0.2); color: #ff9800; }

        .tip-date {
            color: #aaa;
            font-size: 0.9em;
        }

        .tip-match {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin: 15px 0;
            color: var(--primary);
        }

        .tip-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .tip-detail {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .tip-detail-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .tip-detail-value {
            font-weight: bold;
            color: var(--tertiary);
        }

        .booking-codes {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .booking-code {
            display: inline-block;
            padding: 8px 15px;
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Downloads Page */
        .download-card {
            display: flex;
            background: var(--card);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .download-thumb {
            width: 100px;
            height: 140px;
            object-fit: cover;
        }

        .download-info {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .download-title {
            color: var(--tertiary);
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .download-size {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .download-progress {
            width: 100%;
            height: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .download-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .download-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: var(--tertiary);
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }

        /* DRM Player Info */
        .drm-info {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #aaa;
        }

        .drm-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .drm-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .drm-status-connected { background: #4caf50; }
        .drm-status-disconnected { background: #ff0000; }
    </style>
</head>
<body>

    <!-- Splash Screen/Loader -->
    <div id="loader">
        <div class="splash-logo">STANY MIN TV</div>
        <div class="spinner"></div>
        <p style="color: var(--tertiary); margin-top: 20px; font-size: 0.9em;">Loading...</p>
    </div>
    
    <!-- Toast -->
    <div id="toast"></div>

    <!-- WhatsApp Float Button -->
    <div class="whatsapp-float" id="whatsappFloat">
        <i class="fab fa-whatsapp"></i>
    </div>

    <!-- Ad Modal -->
    <div id="adModal" class="ad-modal">
        <div class="marquee-top">
            <div class="marquee-text" id="adMarqueeTop">SPONSOR MESSAGE - WATCH FOR FREE ACCESS</div>
        </div>
        
        <div class="ad-content">
            <div class="ad-media" id="adMedia"></div>
            
            <div class="social-icons-grid" id="socialIconsGrid"></div>
        </div>
        
        <div class="marquee-bottom">
            <div class="marquee-text" id="adMarqueeBottom">THANK YOU FOR WATCHING - STANY MIN TV</div>
        </div>
        
        <div class="ad-controls">
            <div class="ad-timer" id="adTimer">00</div>
            <button class="skip-btn" id="skipAdBtn" onclick="skipAd()">
                <i class="fas fa-forward"></i> SKIP
            </button>
        </div>
    </div>

    <!-- Premium Token Modal -->
    <div id="tokenModal" class="token-modal">
        <span class="close-modal" onclick="closeTokenModal()">×</span>
        <i class="fas fa-key" style="font-size: 3em; color: var(--primary); margin-bottom: 15px;"></i>
        <h3 style="color: var(--tertiary); margin-bottom: 10px; font-size: 1.4em;">Enter Premium Token</h3>
        <p style="color: #ccc; margin-bottom: 20px; font-size: 1em;">Enter your premium token to access content without ads</p>
        <input type="text" id="tokenInput" class="input-box" placeholder="Enter token here" style="text-align: center;">
        <button class="btn" onclick="redeemToken()" style="margin-top: 15px; font-weight: bold;">
            <i class="fas fa-check-circle"></i> Redeem Token
        </button>
        <button class="btn" onclick="showAdModalForFreeAccess()" style="margin-top: 10px; background: #333; color: var(--tertiary);">
            <i class="fas fa-ad"></i> Watch Ad for 3 Hours Free
        </button>
    </div>

    <!-- Age Gate Modal (18+) -->
    <div id="ageGateModal" class="age-gate">
        <div class="age-content">
            <div class="age-warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 style="color: var(--tertiary); margin-bottom: 10px; font-size: 1.5em;">ADULT CONTENT WARNING</h3>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 1.1em;">This section contains content suitable for adults only (18+).</p>
            <p style="color: var(--primary); margin-bottom: 20px; font-weight: bold;">You must be 18 years or older to proceed.</p>
            <div class="age-buttons">
                <button class="age-btn age-confirm" onclick="confirmAge()">
                    <i class="fas fa-check"></i> I am 18+
                </button>
                <button class="age-btn age-exit" onclick="exitAdultSection()">
                    <i class="fas fa-times"></i> Exit
                </button>
            </div>
        </div>
    </div>

    <!-- More Menu Modal -->
    <div id="moreMenuModal" class="more-menu-modal">
        <div class="more-menu-content">
            <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.5em;">
                <i class="fas fa-bars"></i> More Options
            </h3>
            <div class="more-menu-buttons">
                <button class="more-menu-btn" onclick="nav('profile'); closeMoreMenu();">
                    <i class="fas fa-user"></i> Profile
                </button>
                <button class="more-menu-btn" onclick="nav('library'); closeMoreMenu();">
                    <i class="fas fa-book"></i> Library
                </button>
                <button class="more-menu-btn" onclick="nav('downloads'); closeMoreMenu();">
                    <i class="fas fa-download"></i> Downloads
                </button>
                <button class="more-menu-btn" onclick="nav('stories'); closeMoreMenu();">
                    <i class="fas fa-book-open"></i> Stories
                </button>
                <button class="more-menu-btn" onclick="nav('tech'); closeMoreMenu();">
                    <i class="fas fa-laptop-code"></i> Tech Updates
                </button>
                <button class="more-menu-btn" onclick="nav('tips'); closeMoreMenu();">
                    <i class="fas fa-futbol"></i> Betting Tips
                </button>
                <button class="more-menu-btn" onclick="nav('settings'); closeMoreMenu();">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="more-menu-btn" onclick="showLogoutConfirm(); closeMoreMenu();" style="background: #d32f2f;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            <button class="btn" onclick="closeMoreMenu()" style="margin-top: 20px; background: #333; color: var(--tertiary);">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <!-- Custom Logout Confirm Modal -->
    <div id="logoutConfirmModal" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="cancelLogout()">×</span>
            <i class="fas fa-sign-out-alt" style="font-size: 3em; color: var(--error); margin-bottom: 15px;"></i>
            <h3 style="color: var(--tertiary); margin-bottom: 10px; font-size: 1.4em;">Confirm Logout</h3>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 1.1em;">Are you sure you want to logout from STANY MIN TV?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="confirmLogout()" style="background: var(--error); color: var(--tertiary);">
                    <i class="fas fa-sign-out-alt"></i> Yes, Logout
                </button>
                <button class="btn" onclick="cancelLogout()" style="background: #333; color: var(--tertiary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Device Approval Overlay -->
    <div id="deviceOverlay">
        <i class="fas fa-mobile-alt" style="font-size: 4em; color: #FFC107;"></i>
        <h2 style="color: var(--tertiary); margin: 20px 0; font-size: 1.5em;">Device Verification Required</h2>
        <p id="deviceMsg" style="color: #ccc; margin-bottom: 20px; font-size: 1.1em; max-width: 300px;">
            You're trying to login from a new device. Please wait for admin approval.
        </p>
        <button id="refreshDevBtn" class="btn" onclick="refreshDeviceStatus()" style="max-width: 200px; background: #FFC107; color: var(--secondary); font-weight: bold;">
            <i class="fas fa-sync-alt"></i> Check Status
        </button>
        <button class="btn" style="background: #d32f2f; margin-top: 10px; max-width: 200px; color: var(--tertiary); font-weight: bold;" onclick="logoutFromDevice()">
            <i class="fas fa-sign-out-alt"></i> Back to Login
        </button>
    </div>

    <!-- Auth Screen -->
    <div id="authPages" class="auth-screen" style="display:none;">
        <div id="loginPage" class="auth-card">
            <div class="login-header">
                <h2 style="color: var(--primary); font-family: 'Orbitron'; font-size: 1.8em;">STANY MIN TV</h2>
                <p style="color: #ccc;">Welcome Back!</p>
            </div>
            <input type="email" id="lemail" class="input-box" placeholder="Email">
            <input type="password" id="lpass" class="input-box" placeholder="Password">
            <div id="loginError" class="login-error" style="color: var(--error); margin-top: 10px; display: none;">Login failed. Please check your credentials.</div>
            <button class="btn" onclick="login()" style="font-weight: bold;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <p style="margin-top:15px; cursor:pointer; color:var(--primary); font-weight: bold;" onclick="document.getElementById('loginPage').style.display='none'; document.getElementById('regPage').style.display='block';">
                <i class="fas fa-user-plus"></i> Create Account
            </p>
        </div>
        <div id="regPage" class="auth-card" style="display:none;">
            <div class="login-header">
                <h2 style="color: var(--primary); font-family: 'Orbitron'; font-size: 1.8em;">Create Account</h2>
                <p style="color: #ccc;">Join STANY MIN TV</p>
            </div>
            <input type="text" id="rname" class="input-box" placeholder="Full Name">
            <input type="email" id="remail" class="input-box" placeholder="Email">
            <input type="password" id="rpass" class="input-box" placeholder="Password">
            <div id="regError" class="login-error" style="color: var(--error); margin-top: 10px; display: none;"></div>
            <button class="btn" onclick="register()" style="font-weight: bold;">
                <i class="fas fa-user-plus"></i> Register
            </button>
            <p style="margin-top:15px; cursor:pointer; color:var(--primary); font-weight: bold;" onclick="document.getElementById('regPage').style.display='none'; document.getElementById('loginPage').style.display='block';">
                <i class="fas fa-arrow-left"></i> Back to Login
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display:none;">
        <!-- Header with Back Arrow for Chat -->
        <div class="header" id="mainHeader">
            <div class="logo">STANY MIN TV</div>
            <div class="header-icons">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="globalSearch()">
                    <i class="fas fa-search search-icon" onclick="toggleSearch()"></i>
                </div>
                <i class="fas fa-sync-alt" onclick="quickRefresh()" style="cursor:pointer; color:var(--primary);"></i>
                <div class="notification-bell-container" onclick="showNotifModal()">
                    <i class="fas fa-bell"></i>
                    <span id="bellNotification" class="notification-dot" style="position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: var(--error); border-radius: 50%; display: none;"></span>
                </div>
            </div>
        </div>

        <!-- Chat Header (Shows only in Chat page) -->
        <div class="chat-header" id="chatHeader" style="display:none;">
            <i class="fas fa-arrow-left back-arrow" onclick="nav('channels')"></i>
            <div class="chat-title">STANY BOT</div>
        </div>

        <!-- LIVE CHANNELS PAGE -->
        <div id="channels" class="page active">
            <!-- Carousel for Channels -->
            <div class="carousel" id="channelsCarousel">
                <div class="loading-text">Loading carousel...</div>
            </div>

            <h3 class="section-title">
                <i class="fas fa-tv"></i> Live Channels
            </h3>
            <div class="grid" id="chanGrid">
                <div class="loading-text">Loading channels...</div>
            </div>
        </div>

        <!-- MOVIES PAGE -->
        <div id="movies" class="page">
            <!-- Carousel for Movies -->
            <div class="carousel" id="moviesCarousel">
                <div class="loading-text">Loading carousel...</div>
            </div>

            <h3 class="section-title">
                <i class="fas fa-film"></i> Movies
            </h3>
            <div class="grid" id="movGrid">
                <div class="loading-text">Loading movies...</div>
            </div>
        </div>

        <!-- ADULT SECTION (18+) -->
        <div id="adult" class="page">
            <div id="adultContent">
                <div class="loading-text">Adult content loading...</div>
            </div>
        </div>

        <!-- BOT CHAT -->
        <div id="bot" class="page">
            <div class="chat-container" style="height: calc(100vh - 150px); display: flex; flex-direction: column; padding: 15px;">
                <div class="chat-box" id="chatBox" style="flex: 1; overflow-y: auto; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    <div class="msg msg-admin" style="padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 1em; align-self: flex-start; background: var(--primary); color: var(--tertiary); font-weight: bold;">
                        <i class="fas fa-robot"></i> Welcome to Stany Bot! How can I help you?
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="chatInput" class="input-box" style="margin:0; border-radius:20px; flex:1;" placeholder="Message...">
                    <button class="btn" style="width:50px; border-radius:50%; margin:0; font-weight: bold;" onclick="sendChat()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MORE PAGES (Accessed from More Menu) -->

        <!-- PROFILE PAGE -->
        <div id="profile" class="page">
            <div class="profile-box" style="margin: 20px; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--primary);">
                <h2 id="pName" style="color:var(--primary); font-size: 1.4em;">User</h2>
                <p id="pEmail" style="color:#aaa; font-size: 1.1em;">email</p>
                <h3 id="pDays" style="margin-top:10px; font-size: 1.2em;">...</h3>
                <button class="btn" style="margin-top:10px; background:var(--primary); color:var(--tertiary); font-weight: bold;" onclick="quickRefresh()">
                    <i class="fas fa-sync-alt"></i> Refresh App Data
                </button>
                <button class="btn" style="margin-top:10px; background:#333; color:var(--tertiary); font-weight: bold;" onclick="showTokenModal()">
                    <i class="fas fa-key"></i> Enter Premium Token
                </button>
                <button class="btn" style="margin-top:10px; background:#d32f2f; color:var(--tertiary); font-weight: bold;" onclick="showLogoutConfirm()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <!-- Channel Passwords -->
            <div class="profile-box" style="margin: 20px; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--primary);">
                <h3 style="font-size: 1.2em; color: var(--primary);">
                    <i class="fas fa-lock"></i> Channel Passwords
                </h3>
                <select id="pChanSel" class="input-box" style="margin-top: 10px;">
                    <option>Select Channel</option>
                </select>
                <input type="password" id="pNewPass" class="input-box" placeholder="Set Password" style="margin-top: 10px;">
                <button class="btn" onclick="savePass()" style="margin-top: 10px; font-weight: bold;">
                    <i class="fas fa-save"></i> Save Password
                </button>
                <div id="pPassList" style="margin-top:10px;"></div>
            </div>
            
            <!-- Favorites -->
            <div class="profile-box" style="margin: 20px; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--primary);">
                <h3 style="font-size: 1.2em; color: var(--primary);">
                    <i class="fas fa-star"></i> Favorite Channels
                </h3>
                <div id="favoritesList" style="margin-top:10px;"></div>
            </div>
        </div>

        <!-- LIBRARY PAGE -->
        <div id="library" class="page">
            <h3 class="section-title">
                <i class="fas fa-book"></i> My Library
            </h3>
            <div id="libraryContent">
                <div class="loading-text">Loading library content...</div>
            </div>
        </div>

        <!-- DOWNLOADS PAGE -->
        <div id="downloads" class="page">
            <h3 class="section-title">
                <i class="fas fa-download"></i> Downloads
            </h3>
            <div id="downloadsContent">
                <div class="loading-text">Loading downloads...</div>
            </div>
        </div>

        <!-- STORIES/SIMULIZI PAGE -->
        <div id="stories" class="page">
            <h3 class="section-title">
                <i class="fas fa-book-open"></i> Stories & Novels
            </h3>
            <div id="storiesList">
                <div class="loading-text">Loading stories...</div>
            </div>
        </div>

        <!-- TECH UPDATES PAGE -->
        <div id="tech" class="page">
            <h3 class="section-title">
                <i class="fas fa-laptop-code"></i> Tech & Cybersecurity Updates
            </h3>
            <div id="techUpdatesContent">
                <div class="loading-text">Loading tech updates...</div>
            </div>
        </div>

        <!-- BETTING TIPS PAGE -->
        <div id="tips" class="page">
            <h3 class="section-title">
                <i class="fas fa-futbol"></i> Betting Tips
            </h3>
            <div id="bettingTipsContent">
                <div class="loading-text">Loading betting tips...</div>
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="settings" class="page">
            <h3 class="section-title">
                <i class="fas fa-cog"></i> App Settings
            </h3>
            <div class="profile-box" style="margin: 20px; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--primary);">
                <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <span style="color: var(--tertiary);">
                        <i class="fas fa-palette"></i> Theme Color
                    </span>
                    <span id="themeColorValue" style="color: var(--primary); font-weight: bold;">Red</span>
                </div>
                
                <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <span style="color: var(--tertiary);">
                        <i class="fas fa-text-height"></i> Font Size
                    </span>
                    <div>
                        <button onclick="changeFontSize('small')" style="padding: 5px 10px; background: #333; color: var(--tertiary); border: none; border-radius: 5px; margin-left: 5px;">Small</button>
                        <button onclick="changeFontSize('medium')" style="padding: 5px 10px; background: var(--primary); color: var(--tertiary); border: none; border-radius: 5px; margin-left: 5px;">Medium</button>
                        <button onclick="changeFontSize('large')" style="padding: 5px 10px; background: #333; color: var(--tertiary); border: none; border-radius: 5px; margin-left: 5px;">Large</button>
                    </div>
                </div>
                
                <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <span style="color: var(--tertiary);">
                        <i class="fas fa-bell"></i> Notifications
                    </span>
                    <label class="switch">
                        <input type="checkbox" id="notificationsToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <span style="color: var(--tertiary);">
                        <i class="fas fa-ad"></i> Auto-play Ads
                    </span>
                    <label class="switch">
                        <input type="checkbox" id="autoPlayAdsToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <button class="btn" onclick="saveSettings()" style="margin-top: 20px; font-weight: bold;">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a onclick="nav('channels',this)" class="nav-item active">
                <i class="fas fa-tv"></i>Live
            </a>
            <a onclick="nav('movies',this)" class="nav-item">
                <i class="fas fa-film"></i>Movies
            </a>
            <a onclick="enterAdultSection()" class="nav-item">
                <i class="fas fa-user-secret"></i>18+
            </a>
            <a onclick="enterChatPage()" class="nav-item" style="position:relative;">
                <i class="fas fa-robot"></i>Bot
                <span id="botNotification" class="notification-dot" style="position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: var(--error); border-radius: 50%; display: none;"></span>
            </a>
            <a onclick="showMoreMenu()" class="nav-item">
                <i class="fas fa-ellipsis-h"></i>More
            </a>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="blockModal" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="document.getElementById('blockModal').style.display='none'">×</span>
            <i class="fas fa-lock" style="font-size:3em; color:var(--error); margin-bottom:15px;"></i>
            <h3 style="color:var(--tertiary); font-size: 1.4em;">Access Required</h3>
            <p style="color:#ccc; margin:15px 0; font-size: 1.1em;">You need premium access or watch an ad to view this content.</p>
            <button class="btn" onclick="showTokenModal()" style="background:var(--primary); color:var(--tertiary); font-weight: bold;">
                <i class="fas fa-key"></i> Enter Premium Token
            </button>
            <button class="btn" onclick="showAdModalForFreeAccess()" style="background:#FFC107; margin-top:10px; color:var(--secondary); font-weight: bold;">
                <i class="fas fa-ad"></i> Watch Ad for Free Access
            </button>
        </div>
    </div>

    <!-- Story Detail Modal -->
    <div id="storyDetailModal" class="modal">
        <div class="modal-box" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <span class="close-modal" onclick="closeStoryDetail()">×</span>
            <div id="storyDetailContent">
                <!-- Story content will be loaded here -->
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="document.getElementById('detailModal').style.display='none'">×</span>
            <img id="dImg" src="" style="width:100%; height:180px; object-fit:cover; border-radius:10px;">
            <h3 id="dTitle" style="color:var(--primary); margin:10px 0; font-size: 1.3em;"></h3>
            <p id="dDesc" style="color:#aaa; font-size:1em; margin-bottom:15px;"></p>
            
            <!-- DRM Info Display -->
            <div id="drmInfo" class="drm-info" style="display: none;">
                <div><strong>DRM Protected Content</strong></div>
                <div class="drm-status">
                    <span class="drm-status-dot drm-status-connected"></span>
                    <span>License Server: Connected</span>
                </div>
            </div>
            
            <button class="btn" id="dBtn" style="font-weight: bold;">
                <i class="fas fa-play"></i> Watch Now
            </button>
            <button class="btn" onclick="toggleFavorite()" style="margin-top:10px; background:#333; color:var(--tertiary);" id="favoriteBtn">
                <i class="far fa-star"></i> Add to Favorites
            </button>
        </div>
    </div>

    <!-- DRM Player Modal -->
    <div id="playerModal" class="modal">
        <div class="modal-box" style="width:100%; height:100%; max-width:100%; background:black; padding:0; border:none;">
            <span class="close-modal" style="z-index:99; background:rgba(0,0,0,0.5); width:40px; border-radius:50%;" onclick="closePlayer()">×</span>
            
            <!-- DRM Status Display -->
            <div id="playerDrmStatus" style="position: absolute; top: 10px; left: 10px; z-index: 98; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; color: white; font-size: 0.8em; display: none;">
                <i class="fas fa-shield-alt"></i> DRM Protected
            </div>
            
            <video id="videoJS" class="video-js vjs-default-skin vjs-big-play-centered" controls style="width:100%; height:100%;"></video>
        </div>
    </div>

    <div id="passPrompt" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="document.getElementById('passPrompt').style.display='none'">×</span>
            <h3 style="font-size: 1.3em; color: var(--tertiary);">
                <i class="fas fa-lock"></i> Enter Password
            </h3>
            <p id="ppName" style="color:#aaa; margin:10px 0; font-size: 1.1em;"></p>
            <input type="password" id="ppInput" class="input-box" style="text-align:center;">
            <button class="btn" onclick="unlockChan()" style="font-weight: bold;">
                <i class="fas fa-unlock"></i> Unlock
            </button>
        </div>
    </div>

    <div id="notifModal" class="modal">
        <div class="modal-box">
            <span class="close-modal" onclick="closeNotifModal()">×</span>
            <h3 style="color:var(--primary); font-size: 1.3em;">
                <i class="fas fa-bell"></i> Notifications
            </h3>
            <div id="notifList" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDiexD5WK9GLhQldr6zNmC8iYWc4em5eyM",
            authDomain: "stany-min-tv.firebaseapp.com",
            databaseURL: "https://stany-min-tv-default-rtdb.firebaseio.com",
            projectId: "stany-min-tv",
            storageBucket: "stany-min-tv.firebasestorage.app",
            messagingSenderId: "16513327552",
            appId: "1:16513327552:web:b4b2247053f83aa0b8e825",
            measurementId: "G-JM25LJXL5C"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("✅ Firebase initialized successfully");
        } catch (error) {
            console.log("✅ Firebase already initialized");
        }
        
        const auth = firebase.auth();
        const db = firebase.database();

        // Global Variables
        let currentUser = null;
        let userIsPremium = false;
        let premiumExpiry = 0;
        let freeAccessExpiry = 0;
        let allData = {
            channels: [],
            movies: [], 
            adult: [],
            stories: [],
            techUpdates: [],
            bettingTips: [],
            downloads: []
        };
        
        let player = null;
        let pendingContent = null;
        let deviceId = localStorage.getItem('did') || 'dev_'+Date.now();
        localStorage.setItem('did', deviceId);
        
        // DRM Configuration
        let drmConfig = {
            licenseUrl: "",
            bearerToken: "",
            isConfigured: false
        };
        
        // Current Story Reading
        let currentStory = null;
        let currentPartIndex = 0;
        
        // Ad System Variables
        let currentAd = null;
        let adTimerInterval = null;
        let adTimeLeft = 0;
        let isAdPlaying = false;
        let startupAdShown = false;
        
        // Carousel Variables
        let channelsCarouselInterval = null;
        let moviesCarouselInterval = null;
        let currentChannelsSlide = 0;
        let currentMoviesSlide = 0;
        
        // Search Variables
        let isSearchActive = false;
        
        // Social Media Icons Mapping
        const socialIconsMap = {
            'whatsapp': { icon: 'fab fa-whatsapp', color: '#25D366' },
            'telegram': { icon: 'fab fa-telegram', color: '#0088cc' },
            'youtube': { icon: 'fab fa-youtube', color: '#ff0000' },
            'facebook': { icon: 'fab fa-facebook', color: '#1877f2' },
            'instagram': { icon: 'fab fa-instagram', color: '#e4405f' },
            'twitter': { icon: 'fab fa-twitter', color: '#1da1f2' },
            'tiktok': { icon: 'fab fa-tiktok', color: '#000000' },
            'linkedin': { icon: 'fab fa-linkedin', color: '#0a66c2' },
            'snapchat': { icon: 'fab fa-snapchat', color: '#fffc00' },
            'pinterest': { icon: 'fab fa-pinterest', color: '#e60023' },
            'reddit': { icon: 'fab fa-reddit', color: '#ff4500' },
            'discord': { icon: 'fab fa-discord', color: '#5865f2' },
            'twitch': { icon: 'fab fa-twitch', color: '#9146ff' },
            'skype': { icon: 'fab fa-skype', color: '#00aff0' },
            'zoom': { icon: 'fab fa-zoom', color: '#2d8cff' },
            'viber': { icon: 'fab fa-viber', color: '#7360f2' },
            'signal': { icon: 'fab fa-signal', color: '#3a76f0' },
            'wechat': { icon: 'fab fa-weixin', color: '#07c160' },
            'qq': { icon: 'fab fa-qq', color: '#12b7f5' },
            'tumblr': { icon: 'fab fa-tumblr', color: '#001935' },
            'flickr': { icon: 'fab fa-flickr', color: '#ff0084' },
            'github': { icon: 'fab fa-github', color: '#ffffff' },
            'gitlab': { icon: 'fab fa-gitlab', color: '#fc6d26' },
            'medium': { icon: 'fab fa-medium', color: '#000000' },
            'dribbble': { icon: 'fab fa-dribbble', color: '#ea4c89' },
            'behance': { icon: 'fab fa-behance', color: '#0057ff' }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 STANY MIN TV App Initializing...");
            
            // Check local storage for premium status
            const savedPremiumExpiry = localStorage.getItem('premiumExpiry');
            const savedFreeExpiry = localStorage.getItem('freeAccessExpiry');
            
            if (savedPremiumExpiry) premiumExpiry = parseInt(savedPremiumExpiry);
            if (savedFreeExpiry) freeAccessExpiry = parseInt(savedFreeExpiry);
            
            // Load DRM Configuration
            loadDRMConfig();
            
            // Check if user is already logged in
            setTimeout(() => {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("👤 User already logged in:", user.email);
                        checkDevice(user.uid);
                    } else {
                        console.log("👤 No user logged in");
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('authPages').style.display = 'flex';
                    }
                });
            }, 2000);
        });

        // Load DRM Configuration
        function loadDRMConfig() {
            db.ref('drmConfig').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    drmConfig = snapshot.val();
                    drmConfig.isConfigured = true;
                    console.log("✅ DRM Configuration loaded:", drmConfig);
                }
            }).catch(error => {
                console.error("❌ Error loading DRM config:", error);
            });
        }

        // Check Premium Status
        function checkPremiumStatus() {
            const now = Date.now();
            userIsPremium = (premiumExpiry > now) || (freeAccessExpiry > now);
            
            if (premiumExpiry > now) {
                const daysLeft = Math.ceil((premiumExpiry - now) / (1000 * 60 * 60 * 24));
                document.getElementById('pDays').innerHTML = `<span style="color: var(--primary);"><i class="fas fa-crown"></i> PREMIUM: ${daysLeft} days left</span>`;
            } else if (freeAccessExpiry > now) {
                const hoursLeft = Math.ceil((freeAccessExpiry - now) / (1000 * 60 * 60));
                document.getElementById('pDays').innerHTML = `<span style="color: #FFC107;"><i class="fas fa-clock"></i> FREE ACCESS: ${hoursLeft} hours left</span>`;
            } else {
                document.getElementById('pDays').innerHTML = `<span style="color: #ccc;"><i class="fas fa-user"></i> FREE USER - Watch ads for access</span>`;
            }
            
            return userIsPremium;
        }

        // Show Ad Modal
        function showAdModal(adData) {
            currentAd = adData;
            const adModal = document.getElementById('adModal');
            const adMedia = document.getElementById('adMedia');
            const socialGrid = document.getElementById('socialIconsGrid');
            const skipBtn = document.getElementById('skipAdBtn');
            
            // Set marquee texts
            document.getElementById('adMarqueeTop').textContent = adData.marqueeTop || "SPONSOR MESSAGE - STANY MIN TV";
            document.getElementById('adMarqueeBottom').textContent = adData.marqueeBottom || "THANK YOU FOR WATCHING";
            
            // Clear media area
            adMedia.innerHTML = '';
            
            // Set media based on type
            if (adData.type === 'video') {
                const video = document.createElement('video');
                video.src = adData.mediaUrl;
                video.autoplay = true;
                video.controls = false;
                video.style.width = '100%';
                video.style.height = '100%';
                video.onended = function() {
                    adFinished();
                };
                adMedia.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = adData.mediaUrl || 'https://via.placeholder.com/350x200?text=Ad+Image';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                adMedia.appendChild(img);
            }
            
            // Add social media icons
            socialGrid.innerHTML = '';
            if (adData.socialLinks) {
                Object.keys(adData.socialLinks).forEach(platform => {
                    const platformLower = platform.toLowerCase();
                    if (socialIconsMap[platformLower]) {
                        const link = adData.socialLinks[platform];
                        const iconData = socialIconsMap[platformLower];
                        const icon = document.createElement('a');
                        icon.href = link;
                        icon.target = '_blank';
                        icon.className = 'social-icon';
                        icon.innerHTML = `<i class="${iconData.icon}" style="color: ${iconData.color};"></i><span style="font-size: 0.7em;">${platform}</span>`;
                        socialGrid.appendChild(icon);
                    }
                });
            }
            
            // Show/Hide skip button based on premium status
            if (userIsPremium) {
                skipBtn.classList.add('active');
            } else {
                skipBtn.classList.remove('active');
            }
            
            // Set timer
            adTimeLeft = adData.duration || 30;
            document.getElementById('adTimer').textContent = adTimeLeft;
            
            // Start timer
            adTimerInterval = setInterval(() => {
                adTimeLeft--;
                document.getElementById('adTimer').textContent = adTimeLeft;
                
                if (adTimeLeft <= 0) {
                    clearInterval(adTimerInterval);
                    adFinished();
                }
            }, 1000);
            
            // Show modal
            adModal.style.display = 'block';
            isAdPlaying = true;
        }

        // Skip Ad
        function skipAd() {
            if (userIsPremium) {
                clearInterval(adTimerInterval);
                document.getElementById('adModal').style.display = 'none';
                isAdPlaying = false;
                
                if (pendingContent) {
                    playContent(pendingContent);
                    pendingContent = null;
                }
            }
        }

        // Ad Finished
        function adFinished() {
            clearInterval(adTimerInterval);
            document.getElementById('adModal').style.display = 'none';
            isAdPlaying = false;
            
            // Grant 3 hours free access if user is not premium
            if (!userIsPremium) {
                freeAccessExpiry = Date.now() + (3 * 60 * 60 * 1000);
                localStorage.setItem('freeAccessExpiry', freeAccessExpiry);
                checkPremiumStatus();
                showToast("🎉 You got 3 hours free access!", "success");
            }
            
            // Play pending content
            if (pendingContent) {
                playContent(pendingContent);
                pendingContent = null;
            }
        }

        // Show Token Modal
        function showTokenModal() {
            document.getElementById('tokenModal').style.display = 'block';
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').style.display = 'none';
        }

        // Redeem Token
        function redeemToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                showToast("Please enter a token", "warning");
                return;
            }
            
            db.ref('tokens/' + token).once('value').then(snapshot => {
                const tokenData = snapshot.val();
                if (!tokenData) {
                    showToast("Invalid token", "error");
                    return;
                }
                
                if (tokenData.used) {
                    showToast("Token already used", "error");
                    return;
                }
                
                // Calculate duration in milliseconds
                let durationMs = 0;
                switch(tokenData.durationUnit) {
                    case 'seconds': durationMs = tokenData.duration * 1000; break;
                    case 'minutes': durationMs = tokenData.duration * 60 * 1000; break;
                    case 'hours': durationMs = tokenData.duration * 60 * 60 * 1000; break;
                    case 'days': durationMs = tokenData.duration * 24 * 60 * 60 * 1000; break;
                    default: durationMs = tokenData.duration * 24 * 60 * 60 * 1000;
                }
                
                // Update user premium status
                premiumExpiry = Date.now() + durationMs;
                localStorage.setItem('premiumExpiry', premiumExpiry);
                
                // Mark token as used
                db.ref('tokens/' + token).update({
                    used: true,
                    usedBy: currentUser.uid,
                    usedAt: Date.now()
                });
                
                // Update user record
                db.ref('users/' + currentUser.uid).update({
                    premiumExpiry: premiumExpiry,
                    lastTokenUsed: token
                });
                
                closeTokenModal();
                checkPremiumStatus();
                showToast("🎉 Premium token activated!", "success");
                
            }).catch(error => {
                showToast("Error redeeming token: " + error.message, "error");
            });
        }

        // Show Ad Modal for Free Access
        function showAdModalForFreeAccess() {
            // Get random ad from database
            db.ref('ads').once('value').then(snapshot => {
                const ads = [];
                snapshot.forEach(adSnap => {
                    ads.push({id: adSnap.key, ...adSnap.val()});
                });
                
                if (ads.length > 0) {
                    const randomAd = ads[Math.floor(Math.random() * ads.length)];
                    showAdModal(randomAd);
                } else {
                    showToast("No ads available", "warning");
                }
            });
        }

        // Handle content click with ad check
        function handleContentClick(content) {
            if (userIsPremium) {
                // Premium user - direct access
                playContent(content);
            } else {
                // Free user - show token modal or ad
                pendingContent = content;
                showTokenModal();
            }
        }

        // Age Gate Functions
        function enterAdultSection() {
            document.getElementById('ageGateModal').style.display = 'flex';
        }

        function confirmAge() {
            document.getElementById('ageGateModal').style.display = 'none';
            nav('adult');
            loadAdultContent();
        }

        function exitAdultSection() {
            document.getElementById('ageGateModal').style.display = 'none';
            nav('channels');
        }

        // More Menu Functions
        function showMoreMenu() {
            document.getElementById('moreMenuModal').style.display = 'flex';
        }

        function closeMoreMenu() {
            document.getElementById('moreMenuModal').style.display = 'none';
        }

        // Chat Navigation
        function enterChatPage() {
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.querySelector('.bottom-nav').style.display = 'none';
            nav('bot');
            clearChatNotifications();
        }

        // Navigation function with header management
        function nav(page, element) {
            if (page !== 'bot') {
                document.getElementById('mainHeader').style.display = 'flex';
                document.getElementById('chatHeader').style.display = 'none';
                document.querySelector('.bottom-nav').style.display = 'flex';
            }
            
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Hide search if active
            if (isSearchActive) {
                toggleSearch();
            }
            
            if (page === 'bot') {
                clearChatNotifications();
            }
            
            // Load page-specific content
            switch(page) {
                case 'stories':
                    loadStories();
                    break;
                case 'tech':
                    loadTechUpdates();
                    break;
                case 'tips':
                    loadBettingTips();
                    break;
                case 'downloads':
                    loadDownloads();
                    break;
                case 'library':
                    loadLibrary();
                    break;
            }
        }

        // Show Startup Ad
        function showStartupAd() {
            if (startupAdShown) return;
            
            db.ref('ads').orderByChild('type').equalTo('startup').once('value').then(snapshot => {
                const startupAds = [];
                snapshot.forEach(adSnap => {
                    startupAds.push({id: adSnap.key, ...adSnap.val()});
                });
                
                if (startupAds.length > 0 && !userIsPremium) {
                    const randomAd = startupAds[Math.floor(Math.random() * startupAds.length)];
                    setTimeout(() => {
                        showAdModal(randomAd);
                        startupAdShown = true;
                    }, 1000);
                }
            });
        }

        // WhatsApp Float Button
        function showWhatsAppFloat() {
            const floatBtn = document.getElementById('whatsappFloat');
            floatBtn.style.display = 'flex';
            
            db.ref('settings/adminWhatsApp').once('value').then(snapshot => {
                const whatsappNumber = snapshot.val();
                if (whatsappNumber) {
                    floatBtn.onclick = function() {
                        const message = `Hello Admin, I need assistance with my STANY MIN TV account.`;
                        window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`, '_blank');
                    };
                }
            });
        }

        // Hide WhatsApp Float
        function hideWhatsAppFloat() {
            document.getElementById('whatsappFloat').style.display = 'none';
        }

        // Toggle Favorite
        function toggleFavorite() {
            if (!currentUser || !pendingContent) return;
            
            const favoritesRef = db.ref(`users/${currentUser.uid}/favorites/${pendingContent.id}`);
            favoritesRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    favoritesRef.remove();
                    showToast("Removed from favorites", "info");
                    document.getElementById('favoriteBtn').innerHTML = '<i class="far fa-star"></i> Add to Favorites';
                } else {
                    favoritesRef.set({
                        id: pendingContent.id,
                        name: pendingContent.name || pendingContent.title,
                        type: pendingContent.type,
                        addedAt: Date.now()
                    });
                    showToast("Added to favorites", "success");
                    document.getElementById('favoriteBtn').innerHTML = '<i class="fas fa-star" style="color: #FFD700;"></i> Remove from Favorites';
                }
            });
        }

        // Load Favorites
        function loadFavorites() {
            if (!currentUser) return;
            
            db.ref(`users/${currentUser.uid}/favorites`).on('value', snapshot => {
                const favoritesList = document.getElementById('favoritesList');
                favoritesList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    favoritesList.innerHTML = '<p style="color: #888; text-align: center;">No favorites yet</p>';
                    return;
                }
                
                snapshot.forEach(favSnap => {
                    const fav = favSnap.val();
                    favoritesList.innerHTML += `
                        <div style="background:#333; padding:10px; margin-bottom:5px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong style="color: var(--tertiary);">${fav.name}</strong>
                                <div style="font-size:0.8em; color:#aaa;">${fav.type}</div>
                            </div>
                            <div>
                                <i class="fas fa-play" onclick="playFavorite('${fav.id}', '${fav.type}')" style="color:var(--primary); cursor:pointer; margin-right:10px;"></i>
                                <i class="fas fa-trash" onclick="removeFavorite('${fav.id}')" style="color:var(--error); cursor:pointer;"></i>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function playFavorite(id, type) {
            let content;
            if (type === 'channel') {
                content = allData.channels.find(item => item.id === id);
            } else if (type === 'movie') {
                content = allData.movies.find(item => item.id === id);
            } else if (type === 'adult') {
                content = allData.adult.find(item => item.id === id);
            }
            
            if (content) {
                handleContentClick(content);
            }
        }

        function removeFavorite(id) {
            if (!currentUser) return;
            
            db.ref(`users/${currentUser.uid}/favorites/${id}`).remove()
                .then(() => {
                    showToast("Removed from favorites", "info");
                })
                .catch(error => {
                    showToast("Error removing favorite", "error");
                });
        }

        // Toast function
        function showToast(message, type = "info") {
            const toast = document.getElementById('toast');
            const icons = {
                success: "fas fa-check-circle",
                error: "fas fa-exclamation-circle",
                warning: "fas fa-exclamation-triangle",
                info: "fas fa-info-circle"
            };
            
            toast.innerHTML = `<i class="${icons[type] || icons.info}"></i> ${message}`;
            toast.className = `toast-${type}`;
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(200%)';
            }, 4000);
        }

        // DEVICE CHECK SYSTEM
        function checkDevice(uid) {
            console.log("🔍 Checking device for user:", uid);
            console.log("📱 Current device ID:", deviceId);
            
            // Get user data first, then proceed
            db.ref('users/'+uid).once('value').then(userSnap => {
                const u = userSnap.val();
                console.log("📱 User data loaded:", u);
                
                if(!u) { 
                    console.log("❌ No user data found - signing out");
                    auth.signOut(); 
                    return; 
                }
                
                if(u.isBlocked) { 
                    console.log("🚫 User is blocked");
                    showBlockScreen("Account Blocked"); 
                    return; 
                }

                // DEVICE CHECK LOGIC
                if(!u.activeDeviceId) {
                    console.log("📱 First time login - registering device");
                    registerNewDevice(uid, u);
                }
                else if(u.activeDeviceId !== deviceId) {
                    console.log("⚠️ Device mismatch - requiring admin approval");
                    console.log("🆔 Stored device:", u.activeDeviceId);
                    console.log("🆔 Current device:", deviceId);
                    handleDeviceMismatch(uid);
                } else {
                    console.log("✅ Device matches - initializing app");
                    initializeUserApp(uid, u);
                }
            }).catch(error => {
                console.error("❌ Error loading user data:", error);
                showToast("Error loading user data", "error");
                document.getElementById('loader').style.display = 'none';
            });
        }

        // NEW DEVICE REGISTRATION
        function registerNewDevice(uid, userData) {
            db.ref('users/'+uid).update({
                activeDeviceId: deviceId,
                lastLogin: Date.now()
            }).then(() => {
                console.log("✅ Device registered successfully");
                currentUser = {uid:uid, ...userData, activeDeviceId: deviceId};
                
                // Load essential data
                loadEssentialData();
                initApp();
                
            }).catch(error => {
                console.error("❌ Device registration error:", error);
                showToast("Device setup failed", "error");
                document.getElementById('loader').style.display = 'none';
            });
        }

        // DEVICE MISMATCH HANDLING
        function handleDeviceMismatch(uid) {
            showDeviceWait(uid);
            createDeviceRequest(uid);
            startDeviceApprovalCheck(uid);
        }

        // APP INITIALIZATION
        function initializeUserApp(uid, userData) {
            currentUser = {uid:uid, ...userData};
            
            // Check premium status from user data
            if (userData.premiumExpiry) {
                premiumExpiry = userData.premiumExpiry;
                localStorage.setItem('premiumExpiry', premiumExpiry);
            }
            
            // Load essential data
            loadEssentialData();
            initApp();
        }

        // DEVICE APPROVAL CHECK
        let deviceCheckInterval = null;
        function startDeviceApprovalCheck(uid) {
            if (deviceCheckInterval) {
                clearInterval(deviceCheckInterval);
            }
            
            deviceCheckInterval = setInterval(() => {
                checkDeviceApprovalStatus(uid);
            }, 2000);
        }

        // DEVICE APPROVAL STATUS CHECK
        async function checkDeviceApprovalStatus(uid) {
            try {
                const s = await db.ref('deviceRequests/'+uid).once('value');
                const r = s.val();

                if (r && r.status === 'approved' && r.deviceId === deviceId) {
                    // Device approved - update user and initialize app
                    await db.ref('users/'+uid).update({
                        activeDeviceId: deviceId,
                        lastDeviceApproval: Date.now()
                    });
                    await db.ref('deviceRequests/'+uid).remove();
                    
                    // Clear the interval
                    if (deviceCheckInterval) {
                        clearInterval(deviceCheckInterval);
                        deviceCheckInterval = null;
                    }
                    
                    document.getElementById('deviceOverlay').style.display = 'none';
                    showToast("🎉 Device approved! Welcome to STANY MIN TV", "success");
                    
                    // Reload essential data
                    document.getElementById('loader').style.display = 'flex';
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } else if (r && r.status === 'rejected') {
                    // Clear the interval if rejected
                    if (deviceCheckInterval) {
                        clearInterval(deviceCheckInterval);
                        deviceCheckInterval = null;
                    }
                    document.getElementById('deviceMsg').innerText = "❌ Admin Rejected Request. Please contact support.";
                    showToast("Device request was rejected", "error");
                }
            } catch (error) {
                console.error("Error checking device approval:", error);
            }
        }

        // DEVICE REQUEST CREATION
        function createDeviceRequest(uid) {
            const user = auth.currentUser;
            if (!user) {
                console.log("❌ No authenticated user");
                return;
            }
            
            const requestData = {
                email: user.email, 
                deviceId: deviceId, 
                status: 'pending', 
                timestamp: Date.now(),
                userName: user.displayName || 'Unknown User',
                userUid: uid,
                userEmail: user.email
            };
            
            console.log("📨 Creating device request:", requestData);
            
            db.ref('deviceRequests/'+uid).set(requestData)
                .then(() => {
                    console.log("✅ Device request created successfully in database");
                    showToast("📱 Device approval requested. Waiting for admin...", "info");
                })
                .catch(error => {
                    console.error("❌ Failed to create device request:", error);
                    setTimeout(() => createDeviceRequest(uid), 3000);
                });
        }

        // SHOW DEVICE WAIT SCREEN
        function showDeviceWait(uid) {
            console.log("⏳ Showing device wait screen for user:", uid);
            document.getElementById('deviceOverlay').style.display='flex';
            document.getElementById('loader').style.display='none';
            document.getElementById('deviceMsg').innerText = "⏳ Waiting for Admin Approval... Auto-checking every 2 seconds.";
        }

        // REFRESH DEVICE STATUS
        async function refreshDeviceStatus() {
            const btn = document.getElementById('refreshDevBtn');
            const originalText = btn.innerText;
            btn.innerText = "🔄 Checking...";
            btn.disabled = true;
            
            try {
                const uid = auth.currentUser.uid;
                console.log("🔄 Manual device status check for:", uid);
                
                const s = await db.ref('deviceRequests/'+uid).once('value');
                const r = s.val();

                console.log("📋 Device request data:", r);

                if (r && r.status === 'approved' && r.deviceId === deviceId) {
                    console.log("✅ Device approved - updating user record");
                    await db.ref('users/'+uid).update({
                        activeDeviceId: deviceId,
                        lastDeviceApproval: Date.now()
                    });
                    await db.ref('deviceRequests/'+uid).remove();
                    
                    document.getElementById('deviceOverlay').style.display = 'none';
                    showToast("🎉 Device approved! Welcome to STANY MIN TV", "success");
                    
                    document.getElementById('loader').style.display = 'flex';
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } else if (r && r.status === 'rejected') {
                    console.log("❌ Device request rejected");
                    document.getElementById('deviceMsg').innerText = "❌ Admin Rejected Request. Please contact support.";
                    btn.innerText = "❌ Rejected";
                    showToast("Device request was rejected", "error");
                } else {
                    console.log("⏳ Device request still pending");
                    document.getElementById('deviceMsg').innerText = "⏳ Still Pending... Auto-checking every 2 seconds.";
                    btn.innerText = originalText;
                    showToast("Status: Still pending. Auto-checking...", "info");
                }
            } catch (error) {
                console.error("❌ Error checking device status:", error);
                showToast("Error checking status", "error");
                btn.innerText = originalText;
            } finally {
                btn.disabled = false;
            }
        }

        // LOGOUT FROM DEVICE APPROVAL
        function logoutFromDevice() {
            console.log("🚪 Logging out from device approval screen");
            
            if (deviceCheckInterval) {
                clearInterval(deviceCheckInterval);
                deviceCheckInterval = null;
            }
            
            auth.signOut();
            document.getElementById('deviceOverlay').style.display = 'none';
            document.getElementById('authPages').style.display = 'flex';
            document.getElementById('loginPage').style.display = 'block';
            
            showToast("👋 Returned to login page", "info");
        }

        // SHOW BLOCK SCREEN
        function showBlockScreen(msg) {
            document.getElementById('mainApp').style.display='none';
            document.getElementById('deviceOverlay').style.display='flex';
            document.getElementById('deviceMsg').innerText = msg;
            document.getElementById('refreshDevBtn').style.display='none';
        }

        // INIT APP
        function initApp() {
            console.log("🚀 Initializing app for user:", currentUser?.email);
            
            document.getElementById('loader').style.display='none';
            document.getElementById('deviceOverlay').style.display='none';
            document.getElementById('authPages').style.display = 'none';
            document.getElementById('mainApp').style.display='block';
            
            if (!currentUser) {
                console.error("❌ No current user found in initApp");
                return;
            }
            
            // Update profile info
            document.getElementById('pName').innerText = currentUser.name || 'User';
            document.getElementById('pEmail').innerText = currentUser.email;
            
            // Check premium status
            checkPremiumStatus();
            
            // Show startup ad for free users
            showStartupAd();
            
            // Show WhatsApp float
            showWhatsAppFloat();
            
            // Load favorites
            loadFavorites();
            
            // Setup bot
            setupBot();
            
            showToast("🎉 Welcome back to STANY MIN TV!", "success");
            console.log("✅ App initialized successfully");
        }

        // LOAD ESSENTIAL DATA
        function loadEssentialData() {
            console.log("📥 Loading essential data");
            
            // Load channels with real-time listener
            db.ref('channels').on('value', s => {
                processChannelsData(s);
            });
            
            // Load movies with real-time listener
            db.ref('movies').on('value', s => {
                processMoviesData(s);
            });
            
            // Load adult content
            db.ref('adultContent').on('value', s => {
                processAdultData(s);
            });
            
            // Load carousels
            loadCarousels();
            
            // Load channel passwords selector
            loadChannelSelector();
            
            // Load stories
            loadStories();
            
            // Load tech updates
            loadTechUpdates();
            
            // Load betting tips
            loadBettingTips();
            
            // Load downloads
            loadDownloads();
            
            // Load library
            loadLibrary();
        }

        // PROCESS CHANNELS DATA
        function processChannelsData(snapshot) {
            const channelsData = [];
            snapshot.forEach(c => {
                const channel = {id:c.key, ...c.val(), type:'channel'};
                channelsData.push(channel);
            });
            
            allData.channels = channelsData;
            displayChannels(channelsData);
            
            showToast("📺 Channels updated", "info");
        }

        // PROCESS MOVIES DATA
        function processMoviesData(snapshot) {
            const moviesData = [];
            snapshot.forEach(c => {
                moviesData.push({id:c.key, ...c.val(), type:'movie'});
            });
            allData.movies = moviesData;
            displayMovies(moviesData);
            
            showToast("🎬 Movies updated", "info");
        }

        // PROCESS ADULT DATA
        function processAdultData(snapshot) {
            const adultData = [];
            snapshot.forEach(c => {
                adultData.push({id:c.key, ...c.val(), type:'adult'});
            });
            allData.adult = adultData;
            
            // Only display if on adult page
            if (document.getElementById('adult').classList.contains('active')) {
                displayAdultContent(adultData);
            }
        }

        // DISPLAY CHANNELS
        function displayChannels(channels) {
            const g = document.getElementById('chanGrid'); 
            if(channels.length === 0) {
                g.innerHTML = '<div class="loading-text">No channels available</div>';
                return;
            }
            
            let html = '';
            channels.forEach(ch => {
                html += createCard(ch);
            });
            g.innerHTML = html;
        }

        // DISPLAY MOVIES
        function displayMovies(movies) {
            const g = document.getElementById('movGrid'); 
            if(movies.length === 0) {
                g.innerHTML = '<div class="loading-text">No movies available</div>';
                return;
            }
            
            let html = '';
            movies.forEach(m => {
                html += createCard(m);
            });
            g.innerHTML = html;
        }

        // DISPLAY ADULT CONTENT
        function displayAdultContent(adult) {
            const g = document.getElementById('adultContent'); 
            if(adult.length === 0) {
                g.innerHTML = '<div class="loading-text">No adult content available</div>';
                return;
            }
            
            let html = '<div class="grid">';
            adult.forEach(a => {
                html += createCard(a);
            });
            html += '</div>';
            g.innerHTML = html;
        }

        // LOAD ADULT CONTENT
        function loadAdultContent() {
            if (allData.adult.length > 0) {
                displayAdultContent(allData.adult);
            } else {
                db.ref('adultContent').once('value').then(s => {
                    const adultData = [];
                    s.forEach(c => {
                        adultData.push({id:c.key, ...c.val(), type:'adult'});
                    });
                    allData.adult = adultData;
                    displayAdultContent(adultData);
                });
            }
        }

        // CREATE CARD
        function createCard(item) {
            // Check if item is favorite
            let isFavorite = false;
            if (currentUser && currentUser.favorites && currentUser.favorites[item.id]) {
                isFavorite = true;
            }
            
            const favoriteStar = isFavorite ? 
                `<div class="favorite-star"><i class="fas fa-star" style="color: #FFD700;"></i></div>` : 
                `<div class="favorite-star" style="display:none;"><i class="fas fa-star" style="color: #FFD700;"></i></div>`;
            
            return `<div class="card" onclick="handleCardClick('${item.type}','${item.id}')">
                ${favoriteStar}
                <img src="${item.posterURL || 'https://via.placeholder.com/150x200?text=No+Image'}" onerror="this.src='https://via.placeholder.com/150x200?text=No+Image'">
                <div class="card-info"><h4>${item.name||item.title||'Untitled'}</h4></div>
            </div>`;
        }

        // HANDLE CARD CLICK
        function handleCardClick(type, id) {
            let item;
            if (type === 'channel') {
                item = allData.channels.find(x => x.id === id);
            } else if (type === 'movie') {
                item = allData.movies.find(x => x.id === id);
            } else if (type === 'adult') {
                item = allData.adult.find(x => x.id === id);
            }
            
            if (!item) {
                showToast("Item not found", "error");
                return;
            }
            
            pendingContent = item;
            
            // Show detail modal
            document.getElementById('dImg').src = item.posterURL || 'https://via.placeholder.com/300x180?text=No+Image';
            document.getElementById('dTitle').innerText = item.name||item.title||'Untitled';
            document.getElementById('dDesc').innerText = item.description || 'No description available';
            
            // Show DRM info if channel has DRM
            const drmInfo = document.getElementById('drmInfo');
            if (item.drmProtected) {
                drmInfo.style.display = 'block';
            } else {
                drmInfo.style.display = 'none';
            }
            
            // Check if favorite
            const isFavorite = currentUser && currentUser.favorites && currentUser.favorites[item.id];
            document.getElementById('favoriteBtn').innerHTML = isFavorite ? 
                '<i class="fas fa-star" style="color: #FFD700;"></i> Remove from Favorites' : 
                '<i class="far fa-star"></i> Add to Favorites';
            
            document.getElementById('dBtn').onclick = function() {
                document.getElementById('detailModal').style.display='none';
                if (type === 'channel' && currentUser.channelPasswords && currentUser.channelPasswords[item.id]) {
                    checkChanPass(item);
                } else {
                    handleContentClick(item);
                }
            };
            document.getElementById('detailModal').style.display='flex';
        }

        // PLAY CONTENT WITH DRM SUPPORT
        function playContent(item) {
            // Execute channel script if available
            if (item.channelScript) {
                try {
                    eval(item.channelScript);
                    return;
                } catch(e) {
                    console.error("Channel script error:", e);
                }
            }
            
            if (item.playerType === 'external_browser') {
                window.open(item.m3u8Link || item.movieURL, '_blank'); 
                return;
            }
            
            const url = item.m3u8Link || item.movieURL;
            if(!url) { 
                showToast("No URL available for this content", "error"); 
                return; 
            }
            
            document.getElementById('playerModal').style.display='flex';
            
            // Configure DRM if needed
            let playerOptions = {
                fluid: true, 
                autoplay: true,
                preload: 'auto'
            };
            
            // Add DRM configuration if content is DRM protected
            if (item.drmProtected && drmConfig.isConfigured) {
                playerOptions.drm = {
                    servers: {
                        'com.widevine.alpha': drmConfig.licenseUrl
                    }
                };
                
                // Show DRM status
                document.getElementById('playerDrmStatus').style.display = 'block';
                
                // Add authorization header if bearer token exists
                if (drmConfig.bearerToken) {
                    playerOptions.licenseRequestHeaders = {
                        'Authorization': `Bearer ${drmConfig.bearerToken}`
                    };
                }
            }
            
            if(!player) {
                player = videojs('videoJS', playerOptions);
            } else {
                player.reset();
                player.options_ = playerOptions;
            }
            
            player.src({src:url, type: url.includes('.m3u8')?'application/x-mpegURL':'video/mp4'});
            player.play();
        }

        // CHANNEL PASSWORDS
        function checkChanPass(c) {
            if(currentUser.channelPasswords && currentUser.channelPasswords[c.id]) {
                pendingContent = c;
                document.getElementById('ppName').innerText = c.name || 'Channel';
                document.getElementById('passPrompt').style.display='flex';
            } else {
                handleContentClick(c);
            }
        }

        function unlockChan() {
            const inputPass = document.getElementById('ppInput').value;
            if(inputPass === currentUser.channelPasswords[pendingContent.id]) {
                document.getElementById('passPrompt').style.display='none';
                document.getElementById('ppInput').value='';
                handleContentClick(pendingContent);
                showToast("🔓 Channel unlocked successfully!", "success");
            } else {
                showToast("❌ Wrong password", "error");
            }
        }

        // LOAD CAROUSELS
        function loadCarousels() {
            // Load channels carousel
            db.ref('carousel/channels').on('value', snapshot => {
                const carousel = document.getElementById('channelsCarousel');
                displayCarousel(snapshot, carousel, 'channels');
                startCarousel('channels');
            });
            
            // Load movies carousel
            db.ref('carousel/movies').on('value', snapshot => {
                const carousel = document.getElementById('moviesCarousel');
                displayCarousel(snapshot, carousel, 'movies');
                startCarousel('movies');
            });
        }

        // DISPLAY CAROUSEL
        function displayCarousel(snapshot, carouselElement, type) {
            carouselElement.innerHTML = '';
            const slides = [];
            
            if (!snapshot.exists()) {
                carouselElement.innerHTML = '<div class="loading-text">No carousel slides available</div>';
                return;
            }
            
            snapshot.forEach(slide => {
                const slideData = slide.val();
                slides.push(slideData);
            });
            
            if (slides.length > 0) {
                const currentSlide = type === 'channels' ? currentChannelsSlide : currentMoviesSlide;
                const slide = slides[currentSlide % slides.length];
                
                carouselElement.innerHTML = `
                    <div class="carousel-slide active">
                        <img src="${slide.imageURL || 'https://via.placeholder.com/400x200?text=No+Image'}" 
                             onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                        <div class="carousel-caption">
                            <div class="carousel-title">${slide.title || 'No Title'}</div>
                            <div class="carousel-description">${slide.description || ''}</div>
                        </div>
                    </div>
                `;
                
                // Store slides for this carousel
                if (type === 'channels') {
                    window.channelsSlides = slides;
                } else {
                    window.moviesSlides = slides;
                }
            }
        }

        // START CAROUSEL
        function startCarousel(type) {
            if (type === 'channels') {
                if (channelsCarouselInterval) {
                    clearInterval(channelsCarouselInterval);
                }
                
                if (window.channelsSlides && window.channelsSlides.length > 1) {
                    channelsCarouselInterval = setInterval(() => {
                        currentChannelsSlide = (currentChannelsSlide + 1) % window.channelsSlides.length;
                        const carousel = document.getElementById('channelsCarousel');
                        const slide = window.channelsSlides[currentChannelsSlide];
                        
                        carousel.innerHTML = `
                            <div class="carousel-slide active">
                                <img src="${slide.imageURL || 'https://via.placeholder.com/400x200?text=No+Image'}" 
                                     onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                                <div class="carousel-caption">
                                    <div class="carousel-title">${slide.title || 'No Title'}</div>
                                    <div class="carousel-description">${slide.description || ''}</div>
                                </div>
                            </div>
                        `;
                    }, 5000);
                }
            } else {
                if (moviesCarouselInterval) {
                    clearInterval(moviesCarouselInterval);
                }
                
                if (window.moviesSlides && window.moviesSlides.length > 1) {
                    moviesCarouselInterval = setInterval(() => {
                        currentMoviesSlide = (currentMoviesSlide + 1) % window.moviesSlides.length;
                        const carousel = document.getElementById('moviesCarousel');
                        const slide = window.moviesSlides[currentMoviesSlide];
                        
                        carousel.innerHTML = `
                            <div class="carousel-slide active">
                                <img src="${slide.imageURL || 'https://via.placeholder.com/400x200?text=No+Image'}" 
                                     onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                                <div class="carousel-caption">
                                    <div class="carousel-title">${slide.title || 'No Title'}</div>
                                    <div class="carousel-description">${slide.description || ''}</div>
                                </div>
                            </div>
                        `;
                    }, 5000);
                }
            }
        }

        // LOAD CHANNEL SELECTOR
        function loadChannelSelector() {
            const sel = document.getElementById('pChanSel'); 
            sel.innerHTML = '<option>Select Channel</option>';
            
            // Update when channels load
            db.ref('channels').on('value', s => {
                sel.innerHTML = '<option>Select Channel</option>';
                s.forEach(ch => {
                    const channel = ch.val();
                    sel.innerHTML += `<option value="${ch.key}">${channel.name}</option>`;
                });
            });
        }

        // SAVE PASSWORD
        function savePass() {
            const channelId = document.getElementById('pChanSel').value; 
            const password = document.getElementById('pNewPass').value;
            
            if(!channelId || channelId === 'Select Channel') {
                showToast("Please select a channel first", "warning");
                return;
            }
            
            if(!password) {
                showToast("Please enter a password", "warning");
                return;
            }
            
            db.ref(`users/${currentUser.uid}/channelPasswords/${channelId}`).set(password)
                .then(() => {
                    showToast("🔐 Password saved successfully!", "success");
                    document.getElementById('pNewPass').value='';
                    if(!currentUser.channelPasswords) currentUser.channelPasswords = {};
                    currentUser.channelPasswords[channelId] = password;
                    loadPassList();
                })
                .catch(error => {
                    showToast("Error saving password: " + error.message, "error");
                });
        }

        // LOAD PASSWORDS LIST
        function loadPassList() {
            const d = document.getElementById('pPassList'); 
            d.innerHTML='';
            
            if(currentUser.channelPasswords && Object.keys(currentUser.channelPasswords).length > 0) {
                for(let [channelId, password] of Object.entries(currentUser.channelPasswords)) {
                    const channel = allData.channels.find(x=>x.id===channelId);
                    if (channel) {
                        d.innerHTML += `<div style="background:#333; padding:10px; margin-bottom:8px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong style="color: var(--tertiary);">${channel.name}</strong>
                                <div style="font-size:0.8em; color:#aaa;">${'*'.repeat(password.length)}</div>
                            </div>
                            <i class="fas fa-trash" style="color:var(--error); cursor:pointer;" onclick="deletePassword('${channelId}')"></i>
                        </div>`;
                    }
                }
            } else {
                d.innerHTML = '<div style="text-align:center; color:#888; padding:10px;">No passwords set yet</div>';
            }
        }

        // DELETE PASSWORD
        function deletePassword(channelId) {
            if (!confirm("Are you sure you want to delete this password?")) return;
            
            db.ref(`users/${currentUser.uid}/channelPasswords/${channelId}`).remove()
                .then(() => {
                    showToast("🗑️ Password deleted successfully!", "success");
                    delete currentUser.channelPasswords[channelId];
                    loadPassList();
                })
                .catch(error => {
                    showToast("Error deleting password", "error");
                });
        }

        // LOAD STORIES
        function loadStories() {
            if (allData.stories.length > 0 && document.getElementById('stories').classList.contains('active')) {
                displayStories(allData.stories);
                return;
            }
            
            db.ref('stories').on('value', snapshot => {
                const storiesData = [];
                snapshot.forEach(story => {
                    storiesData.push({id: story.key, ...story.val()});
                });
                allData.stories = storiesData;
                
                if (document.getElementById('stories').classList.contains('active')) {
                    displayStories(storiesData);
                }
            });
        }

        function displayStories(stories) {
            const container = document.getElementById('storiesList');
            if (stories.length === 0) {
                container.innerHTML = '<div class="loading-text">No stories available</div>';
                return;
            }
            
            let html = '<div class="grid">';
            stories.forEach(story => {
                html += `
                    <div class="card" onclick="openStory('${story.id}')">
                        <img src="${story.coverImage || 'https://via.placeholder.com/150x200?text=Story+Cover'}" 
                             onerror="this.src='https://via.placeholder.com/150x200?text=Story+Cover'">
                        <div class="card-info">
                            <h4>${story.title || 'Untitled Story'}</h4>
                            <small>${story.author || 'Unknown Author'}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // OPEN STORY
        function openStory(storyId) {
            const story = allData.stories.find(s => s.id === storyId);
            if (!story) {
                showToast("Story not found", "error");
                return;
            }
            
            currentStory = story;
            currentPartIndex = 0;
            
            displayStoryDetail();
        }

        // DISPLAY STORY DETAIL
        function displayStoryDetail() {
            if (!currentStory) return;
            
            const story = currentStory;
            const container = document.getElementById('storyDetailContent');
            
            let html = `
                <div class="story-container">
                    <div class="story-drop-image" style="background-image: url('${story.coverImage || ''}')"></div>
                    <div class="story-content">
                        <h2 class="story-title">${story.title || 'Untitled Story'}</h2>
                        
                        <div class="story-meta">
                            <div class="story-meta-item">
                                <i class="fas fa-user"></i>
                                <span>Author: ${story.author || 'Unknown'}</span>
                            </div>
                            <div class="story-meta-item">
                                <i class="fas fa-tag"></i>
                                <span>Genre: ${story.genre || 'General'}</span>
                            </div>
                            <div class="story-meta-item">
                                <i class="fas fa-book"></i>
                                <span>Parts: ${story.parts ? story.parts.length : 0}</span>
                            </div>
                        </div>
                        
                        <div class="story-about">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">About this story:</h3>
                            <p>${story.about || 'No description available.'}</p>
                        </div>
                        
                        <div class="story-parts" id="storyPartsContent">
                            ${story.parts && story.parts.length > 0 ? `
                                <div class="part-content">
                                    ${story.parts[currentPartIndex] || 'Part content not available.'}
                                </div>
                                
                                <div class="part-navigation">
                                    <button class="part-btn" onclick="prevPart()" ${currentPartIndex === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </button>
                                    
                                    <div class="part-info">
                                        Part ${currentPartIndex + 1} of ${story.parts.length}
                                    </div>
                                    
                                    <button class="part-btn" onclick="nextPart()" ${currentPartIndex === story.parts.length - 1 ? 'disabled' : ''}>
                                        Next <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            ` : '<p>No parts available for this story.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('storyDetailModal').style.display = 'flex';
        }

        // STORY NAVIGATION
        function nextPart() {
            if (!currentStory || !currentStory.parts) return;
            
            if (currentPartIndex < currentStory.parts.length - 1) {
                currentPartIndex++;
                displayStoryDetail();
            }
        }

        function prevPart() {
            if (!currentStory || !currentStory.parts) return;
            
            if (currentPartIndex > 0) {
                currentPartIndex--;
                displayStoryDetail();
            }
        }

        function closeStoryDetail() {
            document.getElementById('storyDetailModal').style.display = 'none';
            currentStory = null;
            currentPartIndex = 0;
        }

        // LOAD TECH UPDATES
        function loadTechUpdates() {
            if (allData.techUpdates.length > 0 && document.getElementById('tech').classList.contains('active')) {
                displayTechUpdates(allData.techUpdates);
                return;
            }
            
            db.ref('techUpdates').on('value', snapshot => {
                const techData = [];
                snapshot.forEach(update => {
                    techData.push({id: update.key, ...update.val()});
                });
                allData.techUpdates = techData;
                
                if (document.getElementById('tech').classList.contains('active')) {
                    displayTechUpdates(techData);
                }
            });
        }

        function displayTechUpdates(updates) {
            const container = document.getElementById('techUpdatesContent');
            if (updates.length === 0) {
                container.innerHTML = '<div class="loading-text">No tech updates available</div>';
                return;
            }
            
            let html = '';
            updates.forEach(update => {
                const date = update.date ? new Date(update.date).toLocaleDateString() : 'Unknown date';
                html += `
                    <div class="tech-update-card">
                        <span class="tech-update-category">${update.category || 'Tech'}</span>
                        <h3 class="tech-update-title">${update.title || 'Untitled Update'}</h3>
                        <div class="tech-update-date">
                            <i class="far fa-calendar"></i> ${date}
                        </div>
                        <div class="tech-update-content">
                            ${update.content || 'No content available.'}
                        </div>
                        ${update.source ? `<div style="font-size: 0.8em; color: #888; margin-top: 10px;">Source: ${update.source}</div>` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // LOAD BETTING TIPS
        function loadBettingTips() {
            if (allData.bettingTips.length > 0 && document.getElementById('tips').classList.contains('active')) {
                displayBettingTips(allData.bettingTips);
                return;
            }
            
            db.ref('bettingTips').on('value', snapshot => {
                const tipsData = [];
                snapshot.forEach(tip => {
                    tipsData.push({id: tip.key, ...tip.val()});
                });
                allData.bettingTips = tipsData;
                
                if (document.getElementById('tips').classList.contains('active')) {
                    displayBettingTips(tipsData);
                }
            });
        }

        function displayBettingTips(tips) {
            const container = document.getElementById('bettingTipsContent');
            if (tips.length === 0) {
                container.innerHTML = '<div class="loading-text">No betting tips available</div>';
                return;
            }
            
            let html = '';
            tips.forEach(tip => {
                const date = tip.date ? new Date(tip.date).toLocaleDateString() : 'Unknown date';
                const statusClass = tip.status === 'successful' ? 'status-success' : 
                                   tip.status === 'failed' ? 'status-failed' : 'status-pending';
                
                // Generate booking codes HTML
                let bookingCodesHtml = '';
                if (tip.bookingCodes && Array.isArray(tip.bookingCodes)) {
                    tip.bookingCodes.forEach(code => {
                        bookingCodesHtml += `<div class="booking-code" onclick="copy('${code.code}')">${code.platform}: ${code.code}</div>`;
                    });
                }
                
                html += `
                    <div class="betting-tip-card">
                        <div class="tip-header">
                            <span class="tip-status ${statusClass}">${tip.status || 'pending'}</span>
                            <span class="tip-date">${date}</span>
                        </div>
                        
                        <div class="tip-match">${tip.team1 || 'Team A'} VS ${tip.team2 || 'Team B'}</div>
                        
                        <div class="tip-details">
                            <div class="tip-detail">
                                <div class="tip-detail-label">Prediction</div>
                                <div class="tip-detail-value">${tip.prediction || 'N/A'}</div>
                            </div>
                            <div class="tip-detail">
                                <div class="tip-detail-label">Odds</div>
                                <div class="tip-detail-value">${tip.odds || 'N/A'}</div>
                            </div>
                            <div class="tip-detail">
                                <div class="tip-detail-label">Stake</div>
                                <div class="tip-detail-value">${tip.stake || 'N/A'}</div>
                            </div>
                            <div class="tip-detail">
                                <div class="tip-detail-label">Result</div>
                                <div class="tip-detail-value">${tip.result || 'Pending'}</div>
                            </div>
                        </div>
                        
                        ${tip.description ? `<div style="margin-top: 15px; color: #ccc; font-size: 0.9em;">${tip.description}</div>` : ''}
                        
                        ${bookingCodesHtml ? `
                            <div class="booking-codes">
                                <div style="font-size: 0.9em; color: #aaa; margin-bottom: 5px;">Booking Codes:</div>
                                ${bookingCodesHtml}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // LOAD DOWNLOADS
        function loadDownloads() {
            if (allData.downloads.length > 0 && document.getElementById('downloads').classList.contains('active')) {
                displayDownloads(allData.downloads);
                return;
            }
            
            db.ref('downloads').on('value', snapshot => {
                const downloadsData = [];
                snapshot.forEach(download => {
                    downloadsData.push({id: download.key, ...download.val()});
                });
                allData.downloads = downloadsData;
                
                if (document.getElementById('downloads').classList.contains('active')) {
                    displayDownloads(downloadsData);
                }
            });
        }

        function displayDownloads(downloads) {
            const container = document.getElementById('downloadsContent');
            if (downloads.length === 0) {
                container.innerHTML = '<div class="loading-text">No downloads available</div>';
                return;
            }
            
            let html = '';
            downloads.forEach(download => {
                const progress = download.progress || 0;
                html += `
                    <div class="download-card">
                        <img src="${download.thumbnail || 'https://via.placeholder.com/100x140?text=Thumbnail'}" 
                             class="download-thumb" 
                             onerror="this.src='https://via.placeholder.com/100x140?text=Thumbnail'">
                        
                        <div class="download-info">
                            <div>
                                <div class="download-title">${download.title || 'Untitled Download'}</div>
                                <div class="download-size">${download.size || 'Unknown size'}</div>
                                
                                ${download.description ? `<div style="color: #aaa; font-size: 0.9em; margin-bottom: 10px;">${download.description}</div>` : ''}
                            </div>
                            
                            <div>
                                ${progress > 0 && progress < 100 ? `
                                    <div class="download-progress">
                                        <div class="download-progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                    <div style="color: #aaa; font-size: 0.8em; text-align: center;">${progress}% downloaded</div>
                                ` : ''}
                                
                                <a href="${download.downloadUrl || '#'}" class="download-btn" target="_blank" ${!download.downloadUrl ? 'onclick="return false;" style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-download"></i> ${download.downloadUrl ? 'Download Now' : 'Coming Soon'}
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // LOAD LIBRARY
        function loadLibrary() {
            const container = document.getElementById('libraryContent');
            
            // Library would contain user's saved content
            // For now, show a message
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #888;">
                    <i class="fas fa-book" style="font-size: 3em; margin-bottom: 20px; color: var(--primary);"></i>
                    <h3 style="color: var(--tertiary); margin-bottom: 10px;">My Library</h3>
                    <p>Your saved content will appear here.</p>
                    <p style="font-size: 0.9em; margin-top: 20px;">Save channels, movies, or stories to build your library.</p>
                </div>
            `;
        }

        // BOT FUNCTIONALITY
        function setupBot() {
            if (!currentUser) return;
            
            db.ref(`stanyBotMessages/${currentUser.uid}`).limitToLast(20).on('child_added', s=>{
                const m = s.val();
                const d = document.createElement('div'); 
                d.className = `msg msg-${m.sender}`; 
                d.innerHTML = `<strong>${m.sender === 'admin' ? 'Stany Bot' : 'You'}:</strong> ${m.text}`;
                const b = document.getElementById('chatBox'); 
                b.appendChild(d); 
                b.scrollTop = b.scrollHeight;
                
                if(m.sender === 'admin' && m.timestamp > (window.lastCheckedChat || 0)) {
                    updateChatNotification();
                }
            });
        }

        function sendChat() {
            if (!currentUser) return;
            
            const text = document.getElementById('chatInput').value.trim();
            if(!text) {
                showToast("Please enter a message", "warning");
                return;
            }
            
            db.ref(`stanyBotMessages/${currentUser.uid}`).push({
                text: text, 
                sender: 'user', 
                timestamp: Date.now(),
                userName: currentUser.name,
                userEmail: currentUser.email,
                userId: currentUser.uid
            });
            
            document.getElementById('chatInput').value='';
            
            // Auto-reply from bot
            setTimeout(() => {
                db.ref(`stanyBotMessages/${currentUser.uid}`).push({
                    text: "Message received. We'll respond shortly.", 
                    sender: 'admin', 
                    timestamp: Date.now()
                });
            }, 1000);
        }

        // CHAT NOTIFICATIONS
        function updateChatNotification() {
            const dot = document.getElementById('botNotification');
            dot.style.display = 'block';
            window.unreadMessages = (window.unreadMessages || 0) + 1;
        }

        function clearChatNotifications() {
            const dot = document.getElementById('botNotification');
            dot.style.display = 'none';
            window.unreadMessages = 0;
            window.lastCheckedChat = Date.now();
        }

        // NOTIFICATION MODAL
        function showNotifModal() {
            document.getElementById('notifModal').style.display='flex';
            loadNotifications();
        }

        function closeNotifModal() {
            document.getElementById('notifModal').style.display='none';
        }

        function loadNotifications() {
            if (!currentUser) return;
            
            db.ref(`userNotifications/${currentUser.uid}`).limitToLast(10).once('value').then(snapshot => {
                const notifList = document.getElementById('notifList');
                notifList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    notifList.innerHTML = '<p style="color: #888; text-align: center;">No notifications</p>';
                    return;
                }
                
                snapshot.forEach(notifSnap => {
                    const notif = notifSnap.val();
                    notifList.innerHTML = `
                        <div style="background:#333; padding:10px; margin-bottom:5px; border-radius:10px;">
                            <strong style="color: var(--primary);">${notif.title || 'Notification'}</strong><br>
                            <span style="color: #ccc;">${notif.message || ''}</span>
                            <div style="font-size:0.7em; color:#888; margin-top:5px;">${new Date(notif.timestamp).toLocaleString()}</div>
                        </div>
                    ` + notifList.innerHTML;
                });
            });
        }

        // SEARCH FUNCTIONALITY
        function toggleSearch() {
            const searchInput = document.getElementById('searchInput');
            isSearchActive = !isSearchActive;
            
            if (isSearchActive) {
                searchInput.classList.add('active');
                searchInput.focus();
            } else {
                searchInput.classList.remove('active');
                searchInput.value = '';
                // Clear search and show all content
                globalSearch();
            }
        }

        function globalSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const currentPage = document.querySelector('.page.active').id;
            
            if (!query) {
                // Reset to normal view
                switch(currentPage) {
                    case 'channels': displayChannels(allData.channels); break;
                    case 'movies': displayMovies(allData.movies); break;
                    case 'adult': displayAdultContent(allData.adult); break;
                    case 'stories': displayStories(allData.stories); break;
                    case 'tech': displayTechUpdates(allData.techUpdates); break;
                    case 'tips': displayBettingTips(allData.bettingTips); break;
                }
                return;
            }
            
            switch(currentPage) {
                case 'channels':
                    const filteredChannels = allData.channels.filter(ch => 
                        (ch.name && ch.name.toLowerCase().includes(query)) ||
                        (ch.description && ch.description.toLowerCase().includes(query))
                    );
                    displayFilteredChannels(filteredChannels);
                    break;
                    
                case 'movies':
                    const filteredMovies = allData.movies.filter(m => 
                        (m.title && m.title.toLowerCase().includes(query)) ||
                        (m.description && m.description.toLowerCase().includes(query))
                    );
                    displayFilteredMovies(filteredMovies);
                    break;
                    
                case 'stories':
                    const filteredStories = allData.stories.filter(s => 
                        (s.title && s.title.toLowerCase().includes(query)) ||
                        (s.author && s.author.toLowerCase().includes(query)) ||
                        (s.genre && s.genre.toLowerCase().includes(query))
                    );
                    displayFilteredStories(filteredStories);
                    break;
                    
                case 'tech':
                    const filteredTech = allData.techUpdates.filter(t => 
                        (t.title && t.title.toLowerCase().includes(query)) ||
                        (t.content && t.content.toLowerCase().includes(query)) ||
                        (t.category && t.category.toLowerCase().includes(query))
                    );
                    displayFilteredTech(filteredTech);
                    break;
                    
                case 'tips':
                    const filteredTips = allData.bettingTips.filter(t => 
                        (t.team1 && t.team1.toLowerCase().includes(query)) ||
                        (t.team2 && t.team2.toLowerCase().includes(query)) ||
                        (t.prediction && t.prediction.toLowerCase().includes(query))
                    );
                    displayFilteredTips(filteredTips);
                    break;
            }
        }

        function displayFilteredChannels(channels) {
            const g = document.getElementById('chanGrid'); 
            if(channels.length === 0) {
                g.innerHTML = '<div class="loading-text">No channels found</div>';
                return;
            }
            
            let html = '';
            channels.forEach(ch => {
                html += createCard(ch);
            });
            g.innerHTML = html;
        }

        function displayFilteredMovies(movies) {
            const g = document.getElementById('movGrid'); 
            if(movies.length === 0) {
                g.innerHTML = '<div class="loading-text">No movies found</div>';
                return;
            }
            
            let html = '';
            movies.forEach(m => {
                html += createCard(m);
            });
            g.innerHTML = html;
        }

        function displayFilteredStories(stories) {
            const container = document.getElementById('storiesList');
            if (stories.length === 0) {
                container.innerHTML = '<div class="loading-text">No stories found</div>';
                return;
            }
            
            let html = '<div class="grid">';
            stories.forEach(story => {
                html += `
                    <div class="card" onclick="openStory('${story.id}')">
                        <img src="${story.coverImage || 'https://via.placeholder.com/150x200?text=Story+Cover'}" 
                             onerror="this.src='https://via.placeholder.com/150x200?text=Story+Cover'">
                        <div class="card-info">
                            <h4>${story.title || 'Untitled Story'}</h4>
                            <small>${story.author || 'Unknown Author'}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayFilteredTech(updates) {
            const container = document.getElementById('techUpdatesContent');
            if (updates.length === 0) {
                container.innerHTML = '<div class="loading-text">No tech updates found</div>';
                return;
            }
            
            let html = '';
            updates.forEach(update => {
                const date = update.date ? new Date(update.date).toLocaleDateString() : 'Unknown date';
                html += `
                    <div class="tech-update-card">
                        <span class="tech-update-category">${update.category || 'Tech'}</span>
                        <h3 class="tech-update-title">${update.title || 'Untitled Update'}</h3>
                        <div class="tech-update-date">
                            <i class="far fa-calendar"></i> ${date}
                        </div>
                        <div class="tech-update-content">
                            ${update.content || 'No content available.'}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayFilteredTips(tips) {
            const container = document.getElementById('bettingTipsContent');
            if (tips.length === 0) {
                container.innerHTML = '<div class="loading-text">No betting tips found</div>';
                return;
            }
            
            let html = '';
            tips.forEach(tip => {
                const date = tip.date ? new Date(tip.date).toLocaleDateString() : 'Unknown date';
                const statusClass = tip.status === 'successful' ? 'status-success' : 
                                   tip.status === 'failed' ? 'status-failed' : 'status-pending';
                
                html += `
                    <div class="betting-tip-card">
                        <div class="tip-header">
                            <span class="tip-status ${statusClass}">${tip.status || 'pending'}</span>
                            <span class="tip-date">${date}</span>
                        </div>
                        <div class="tip-match">${tip.team1 || 'Team A'} VS ${tip.team2 || 'Team B'}</div>
                        <div style="text-align: center; color: var(--tertiary); margin: 10px 0;">
                            ${tip.prediction || 'N/A'} @ ${tip.odds || 'N/A'}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // QUICK REFRESH
        function quickRefresh() {
            showToast("🔄 Refreshing data...", "info");
            loadEssentialData();
            checkPremiumStatus();
        }

        // LOGOUT FUNCTIONS
        function showLogoutConfirm() {
            document.getElementById('logoutConfirmModal').style.display = 'flex';
        }

        function cancelLogout() {
            document.getElementById('logoutConfirmModal').style.display = 'none';
        }

        function confirmLogout() {
            console.log("🚪 Logging out user");
            
            // Clear intervals
            if (deviceCheckInterval) clearInterval(deviceCheckInterval);
            if (channelsCarouselInterval) clearInterval(channelsCarouselInterval);
            if (moviesCarouselInterval) clearInterval(moviesCarouselInterval);
            if (adTimerInterval) clearInterval(adTimerInterval);
            
            auth.signOut();
            document.getElementById('logoutConfirmModal').style.display = 'none';
            showToast("👋 Logged out successfully", "info");
            
            // Clear login fields
            document.getElementById('lemail').value = '';
            document.getElementById('lpass').value = '';
        }

        // LOGIN FUNCTION
        function login() { 
            const email = document.getElementById('lemail').value;
            const password = document.getElementById('lpass').value;
            const loginError = document.getElementById('loginError');
            
            document.getElementById('lemail').classList.remove('input-error');
            document.getElementById('lpass').classList.remove('input-error');
            loginError.style.display = 'none';
            
            if(!email || !password) {
                showToast("Please enter email and password", "warning");
                if(!email) document.getElementById('lemail').classList.add('input-error');
                if(!password) document.getElementById('lpass').classList.add('input-error');
                return;
            }
            
            console.log("🔐 Attempting login for:", email);
            
            const loginBtn = document.querySelector('#loginPage .btn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            loginBtn.disabled = true;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("✅ Login successful for:", email);
                    showToast("🔐 Login successful!", "success");
                    document.getElementById('loader').style.display = 'flex';
                    
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                })
                .catch(e => {
                    console.error("❌ Login failed:", e.message);
                    
                    loginError.style.display = 'block';
                    document.getElementById('lemail').classList.add('input-error');
                    document.getElementById('lpass').classList.add('input-error');
                    
                    showToast("❌ " + e.message, "error");
                    
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                });
        }
        
        // REGISTER FUNCTION
        function register() { 
            const name = document.getElementById('rname').value;
            const email = document.getElementById('remail').value;
            const password = document.getElementById('rpass').value;
            const regError = document.getElementById('regError');
            
            document.getElementById('rname').classList.remove('input-error');
            document.getElementById('remail').classList.remove('input-error');
            document.getElementById('rpass').classList.remove('input-error');
            regError.style.display = 'none';
            
            if(!name || !email || !password) {
                showToast("Please fill all fields", "warning");
                if(!name) document.getElementById('rname').classList.add('input-error');
                if(!email) document.getElementById('remail').classList.add('input-error');
                if(!password) document.getElementById('rpass').classList.add('input-error');
                return;
            }
            
            console.log("📝 Attempting registration for:", email);
            
            const regBtn = document.querySelector('#regPage .btn');
            const originalText = regBtn.innerHTML;
            regBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
            regBtn.disabled = true;

            db.ref('users').orderByChild('activeDeviceId').equalTo(deviceId).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        console.log("❌ Device already registered to another account");
                        showToast("This device is already registered. Please login instead.", "error");
                        
                        regBtn.innerHTML = originalText;
                        regBtn.disabled = false;
                        return;
                    }
                    
                    auth.createUserWithEmailAndPassword(email, password)
                        .then(user => {
                            console.log("✅ User created, now saving to database");
                            return db.ref('users/' + user.user.uid).set({
                                name: name,
                                email: email,
                                activeDeviceId: deviceId,
                                registeredAt: Date.now(),
                                premiumExpiry: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days free trial
                            });
                        })
                        .then(() => {
                            console.log("✅ Registration completed successfully");
                            showToast("🎉 Registration successful! 7 days free trial activated.", "success");
                            
                            regBtn.innerHTML = originalText;
                            regBtn.disabled = false;
                        })
                        .catch(e => {
                            console.error("❌ Registration failed:", e.message);
                            regError.style.display = 'block';
                            regError.textContent = e.message;
                            showToast("❌ " + e.message, "error");
                            
                            regBtn.innerHTML = originalText;
                            regBtn.disabled = false;
                        });
                })
                .catch(error => {
                    console.error("❌ Error checking device registration:", error);
                    showToast("Error checking device registration: " + error.message, "error");
                    
                    regBtn.innerHTML = originalText;
                    regBtn.disabled = false;
                });
        }

        // CLOSE PLAYER
        function closePlayer() { 
            document.getElementById('playerModal').style.display = 'none'; 
            document.getElementById('playerDrmStatus').style.display = 'none';
            if(player) {
                player.pause();
                player.reset();
            }
        }

        // COPY FUNCTION
        function copy(text) { 
            navigator.clipboard.writeText(text).then(() => {
                showToast("📋 Copied to clipboard!", "success");
            }).catch(() => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                showToast("📋 Copied!", "success");
            });
        }

        // SETTINGS FUNCTIONS
        function changeFontSize(size) {
            document.body.style.fontSize = size === 'small' ? '14px' : size === 'large' ? '18px' : '16px';
            localStorage.setItem('fontSize', size);
            showToast(`Font size changed to ${size}`, "success");
        }

        function saveSettings() {
            const notifications = document.getElementById('notificationsToggle').checked;
            const autoPlayAds = document.getElementById('autoPlayAdsToggle').checked;
            
            localStorage.setItem('notifications', notifications);
            localStorage.setItem('autoPlayAds', autoPlayAds);
            
            showToast("Settings saved successfully!", "success");
        }

        // FALLBACK INITIALIZATION
        setTimeout(() => {
            if(auth.currentUser && document.getElementById('authPages').style.display !== 'flex') {
                console.log("🔄 Manual auth state recovery");
                document.getElementById('authPages').style.display='none';
                document.getElementById('loader').style.display='flex';
                checkDevice(auth.currentUser.uid);
            }
        }, 5000);

    </script>
</body>
</html>
