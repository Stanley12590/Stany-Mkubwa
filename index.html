<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STANY MIN TV</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- SHAKA PLAYER (PREMIUM DRM) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/controls.min.css">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #ff0000; /* Premium Red */
            --dark: #000000;
            --card-bg: #121212;
            --text: #ffffff;
            --gray: #888888;
            --glass: rgba(18, 18, 18, 0.95);
            --gold: #ffd700;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--dark); color: var(--text); overflow: hidden; height: 100vh; width: 100vw; }

        /* --- 1. NEW ANIMATION (FEATURE J) --- */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; perspective: 1000px;
        }
        
        /* 3D Elements Dropping */
        .anim-item { opacity: 0; transform: translateY(-500px) rotateX(45deg); transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .tv-box { 
            width: 100px; height: 80px; border: 4px solid var(--primary); border-radius: 10px;
            position: relative; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 30px rgba(255,0,0,0.3);
        }
        .antenna {
            position: absolute; top: -30px; width: 60px; height: 30px;
            border-left: 4px solid var(--primary); border-bottom: 4px solid var(--primary);
            transform: rotate(45deg); left: 20px;
        }
        .tv-screen { font-size: 30px; color: white; font-weight: bold; }
        
        .app-name-anim { 
            font-size: 28px; font-weight: 800; margin-top: 20px; letter-spacing: 2px;
            text-shadow: 0 5px 15px rgba(255,0,0,0.5); transform: scale(0); transition: 0.5s;
        }

        .anim-active .anim-item { opacity: 1; transform: translateY(0) rotateX(0); }
        .anim-active .app-name-anim { transform: scale(1); }

        /* --- 2. AUTH SCREEN (LOGIN & REGISTER) --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #000, #1a0000); z-index: 5000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px;
        }
        .auth-card {
            width: 100%; background: #1a1a1a; padding: 25px; border-radius: 20px;
            border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; color: var(--gray); cursor: pointer; font-weight: bold; }
        .auth-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        
        .input-group { margin-bottom: 15px; }
        .input-box { 
            width: 100%; padding: 14px; background: #000; border: 1px solid #333; 
            color: white; border-radius: 10px; font-size: 14px;
        }
        .btn { 
            width: 100%; padding: 14px; background: var(--primary); color: white; 
            border: none; border-radius: 10px; font-weight: bold; font-size: 16px; 
            cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(255,0,0,0.3);
        }
        .btn-google {
            background: white; color: black; display: flex; align-items: center; 
            justify-content: center; gap: 10px; margin-top: 20px;
        }

        /* --- 3. MAIN UI (IOS 26 STYLE) --- */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        
        .header { 
            padding: 15px 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222;
        }
        .logo-text { font-size: 20px; font-weight: 800; color: white; }
        .logo-text span { color: var(--primary); }
        .profile-btn { width: 35px; height: 35px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--primary); }
        .profile-btn img { width: 100%; height: 100%; object-fit: cover; }

        .content-area { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }

        /* CARDS (B: 2 Per Row) */
        .section-title { font-size: 16px; font-weight: 700; margin: 20px 0 10px; color: #ddd; display: flex; align-items: center; gap: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .card { 
            background: var(--card-bg); border-radius: 12px; overflow: hidden; position: relative; 
            aspect-ratio: 2/3; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .card:active { transform: scale(0.96); }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: linear-gradient(transparent, #000); padding: 15px 10px 8px; 
        }
        .card-title { font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .badge { position: absolute; top: 8px; right: 8px; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; z-index: 2; }
        .badge-vip { background: var(--gold); color: black; }
        .badge-free { background: var(--primary); color: white; }

        /* NAVIGATION (iOS Floating) */
        .nav-bar { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 65px; 
            background: rgba(20,20,20,0.9); backdrop-filter: blur(20px); border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center; 
            border: 1px solid #333; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nav-item { color: #666; font-size: 22px; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: var(--primary); border-radius: 50%; }

        /* --- CHAT ROOM (C) --- */
        .chat-view { display: flex; flex-direction: column; height: 100%; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .chat-msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 13px; position: relative; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-other { align-self: flex-start; background: #222; color: #ddd; border-bottom-left-radius: 2px; }
        .msg-name { font-size: 10px; opacity: 0.7; display: block; margin-bottom: 2px; color: var(--gold); }
        .chat-input-bar { padding: 10px; background: #111; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px; background: #222; border: none; border-radius: 25px; color: white; }

        /* --- BOOK / TECH READER (K) --- */
        .book-list { display: flex; flex-direction: column; gap: 10px; }
        .book-item { background: #1a1a1a; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .reader-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; padding: 20px; overflow-y: auto; display: none; }
        .reader-content { font-size: 16px; line-height: 1.8; color: #ccc; text-align: justify; margin-top: 20px; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .modal-card { background: #151515; width: 85%; padding: 25px; border-radius: 20px; border: 1px solid var(--primary); text-align: center; }
        .hwid-disp { font-family: monospace; background: #000; padding: 8px; color: var(--primary); margin: 10px 0; border: 1px dashed #333; font-size: 12px; }

        /* --- PLAYER --- */
        #player-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; flex-direction: column; justify-content: center; }
        #video { width: 100%; height: 100%; }
        .close-player { position: absolute; top: 20px; left: 20px; color: white; font-size: 30px; z-index: 5001; cursor: pointer; text-shadow: 0 0 10px black; }

        /* --- FLOATING & ADS --- */
        .wa-float { position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px; background: #25D366; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; z-index: 900; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .ad-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Side Menu */
        .side-menu { position: fixed; top: 0; right: -80%; width: 70%; height: 100%; background: #111; z-index: 2000; padding: 20px; transition: 0.3s; border-left: 1px solid #333; }
        .side-menu.open { right: 0; }
        .menu-item { padding: 15px 0; border-bottom: 1px solid #222; font-weight: bold; display: flex; align-items: center; gap: 10px; }

        /* Notifications */
        .notif-badge { position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; display: none; }
        
        #injected-code { display: none; }
    </style>
</head>
<body>

    <!-- 1. SPLASH SCREEN (ANIMATION J) -->
    <div id="splash">
        <div class="tv-box anim-item">
            <div class="antenna"></div>
            <div class="tv-screen">S</div>
        </div>
        <div class="app-name-anim">STANY MIN TV</div>
    </div>

    <!-- 2. AUTH SCREEN (LOGIN/REGISTER/GOOGLE) -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="text-align: center; color: var(--primary); margin-bottom: 20px;">WELCOME</h2>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuth('login')">LOGIN</div>
                <div class="auth-tab" onclick="switchAuth('register')">REGISTER</div>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <div class="input-group">
                    <input type="email" id="l-email" class="input-box" placeholder="Email Address">
                </div>
                <div class="input-group">
                    <input type="password" id="l-pass" class="input-box" placeholder="Password">
                </div>
                <button class="btn" onclick="emailLogin()">LOGIN</button>
            </div>

            <!-- Register Form -->
            <div id="register-form" style="display: none;">
                <div class="input-group">
                    <input type="text" id="r-name" class="input-box" placeholder="Full Name">
                </div>
                <div class="input-group">
                    <input type="email" id="r-email" class="input-box" placeholder="Email Address">
                </div>
                <div class="input-group">
                    <input type="password" id="r-pass" class="input-box" placeholder="Password (6+ chars)">
                </div>
                <button class="btn" onclick="emailRegister()">REGISTER</button>
            </div>

            <div class="btn-google btn" onclick="googleLogin()">
                <i class="fab fa-google"></i> Continue with Google
            </div>
            <p id="auth-msg" style="color: var(--danger); text-align: center; margin-top: 15px; font-size: 12px;"></p>
        </div>
    </div>

    <!-- 3. MAIN APP -->
    <div id="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-text">STANY <span>MIN TV</span></div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <i class="fas fa-sync-alt" style="color: white;" onclick="location.reload()"></i>
                <div style="position: relative;" onclick="openPage('notif')">
                    <i class="fas fa-bell" style="color: white;"></i>
                    <div class="notif-badge"></div>
                </div>
                <div class="profile-btn" onclick="openProfile()">
                    <img id="header-pic" src="https://via.placeholder.com/50">
                </div>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content-area">
            
            <!-- HOME VIEW -->
            <div id="view-home">
                <!-- Banner Slider (Auto) -->
                <div id="banner-slider" style="height: 200px; border-radius: 15px; overflow: hidden; margin-bottom: 20px; position: relative;">
                    <img id="banner-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(transparent, #000); padding: 10px; color: white; font-weight: bold;">Featured Movie</div>
                </div>

                <div class="section-title"><i class="fas fa-tv" style="color:var(--primary);"></i> Live Channels</div>
                <div id="channels-grid" class="grid"></div>

                <div class="section-title"><i class="fas fa-film" style="color:var(--primary);"></i> Latest Movies</div>
                <div id="movies-grid" class="grid"></div>
            </div>

            <!-- CHAT VIEW (C) -->
            <div id="view-chat" style="display: none; height: 100%;">
                <div class="chat-view">
                    <div id="chat-messages" class="chat-list"></div>
                    <div class="chat-input-bar">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type message...">
                        <button onclick="sendChat()" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); border: none; color: white;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- LIBRARY VIEW (Stories & Tech) -->
            <div id="view-library" style="display: none;">
                <div class="section-title">Simulizi (Stories)</div>
                <div id="stories-list" class="book-list"></div>
                
                <div class="section-title">Tech Updates</div>
                <div id="tech-list" class="book-list"></div>
                
                <div class="section-title">Downloads</div>
                <div id="downloads-list" class="book-list"></div>
            </div>

            <!-- NOTIFICATIONS & REQUESTS -->
            <div id="view-notif" style="display: none;">
                <div class="section-title">Notifications</div>
                <div id="notif-list" class="book-list"></div>
                
                <div class="section-title">Requests & Complaints</div>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 10px;">
                    <textarea id="req-text" class="input-box" rows="3" placeholder="Movie request or Complaint..."></textarea>
                    <button class="btn" onclick="sendRequest()">Send to Admin</button>
                </div>
            </div>

        </div>

        <!-- NAV BAR -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="switchTab('library', this)"><i class="fas fa-book"></i></div>
            <div class="nav-item" onclick="switchTab('chat', this)"><i class="fas fa-comments"></i></div>
            <div class="nav-item" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
        </div>

    </div>

    <!-- SIDE MENU -->
    <div id="side-menu" class="side-menu">
        <h2 style="color: var(--primary); margin-bottom: 20px;">MENU</h2>
        <div class="menu-item" onclick="openProfile()"><i class="fas fa-user"></i> My Profile</div>
        <div class="menu-item" onclick="openPage('view-notif')"><i class="fas fa-bell"></i> Notifications</div>
        <div class="menu-item" onclick="window.open('https://wa.me/'+adminNumber, '_blank')"><i class="fab fa-whatsapp"></i> Support</div>
        <div class="menu-item" style="color: var(--danger);" onclick="auth.signOut()"><i class="fas fa-sign-out-alt"></i> Logout</div>
        <div class="menu-item" onclick="toggleMenu()" style="margin-top: auto; justify-content: center; background: #222; border-radius: 10px;">CLOSE</div>
    </div>

    <!-- MODALS -->
    
    <!-- Profile Modal (G & M) -->
    <div id="profile-modal" class="modal-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-card">
            <img id="p-img" src="" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px;">
            <h3 id="p-name">User</h3>
            <p id="p-email" style="color: gray; font-size: 12px;">email</p>
            <div class="hwid-box">
                <small>DEVICE ID (HWID):</small>
                <div id="p-hwid" class="hwid-disp">LOADING...</div>
            </div>
            <button class="btn" style="background: #333; font-size: 12px;" onclick="copyHwid()">Copy ID for Admin</button>
            <div id="p-sub" style="margin-top: 15px; color: var(--gold); font-weight: bold;">Checking Subscription...</div>
        </div>
    </div>

    <!-- Reader Modal (K) -->
    <div id="reader-modal" class="reader-modal">
        <i class="fas fa-arrow-left" style="font-size: 24px; color: var(--primary); margin-bottom: 20px;" onclick="document.getElementById('reader-modal').style.display='none'"></i>
        <h2 id="read-title" style="color: var(--primary);">Title</h2>
        <div id="read-content" class="reader-content"></div>
    </div>

    <!-- Player Modal (F) -->
    <div id="player-modal">
        <i class="fas fa-times close-player" onclick="closePlayer()"></i>
        <video id="video" width="100%" height="100%" controls autoplay></video>
    </div>

    <!-- Ad Overlay (L) -->
    <div id="ad-overlay" class="ad-modal">
        <div style="background: white; padding: 5px 10px; border-radius: 5px; position: absolute; top: 20px; right: 20px; color: black; font-weight: bold;">AD <span id="ad-timer">15</span>s</div>
        <img id="ad-img" src="" style="max-width: 90%; max-height: 50%; border-radius: 10px; margin-bottom: 20px;">
        <button id="ad-btn" class="btn" style="width: 200px;" onclick="openAd()">Visit Site</button>
        <button id="ad-skip" class="btn" style="width: 200px; background: #333; display: none;" onclick="closeAd()">Skip Ad</button>
    </div>

    <!-- WhatsApp Float -->
    <a href="#" id="wa-link" class="wa-float"><i class="fab fa-whatsapp"></i></a>

    <!-- Injected Code Receiver -->
    <div id="injected-code"></div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDiexD5WK9GLhQldr6zNmC8iYWc4em5eyM",
            authDomain: "stany-min-tv.firebaseapp.com",
            databaseURL: "https://stany-min-tv-default-rtdb.firebaseio.com",
            projectId: "stany-min-tv",
            storageBucket: "stany-min-tv.firebasestorage.app",
            messagingSenderId: "16513327552",
            appId: "1:16513327552:web:b4b2247053f83aa0b8e825",
            measurementId: "G-JM25LJXL5C"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // VARIABLES
        let currentUser = null;
        let userData = null;
        let shakaPlayer = null;
        let adminNumber = "";
        let currentAd = null;
        
        // HWID GENERATION (A)
        let HWID = localStorage.getItem('hwid');
        if(!HWID) {
            HWID = 'ID_' + Math.random().toString(36).substr(2, 9).toUpperCase() + navigator.hardwareConcurrency;
            localStorage.setItem('hwid', HWID);
        }

        // --- SPLASH ANIMATION ---
        window.onload = () => {
            const splash = document.getElementById('splash');
            const box = document.querySelector('.tv-box');
            setTimeout(() => { box.parentElement.classList.add('anim-active'); }, 500);
            setTimeout(() => {
                splash.style.opacity = 0;
                setTimeout(() => splash.style.display='none', 800);
            }, 4000); // 4s Animation
            
            initShaka();
        };

        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                checkUserDB(user);
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        function switchAuth(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if(tab === 'login') {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            } else {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            }
        }

        function emailLogin() {
            const e = document.getElementById('l-email').value;
            const p = document.getElementById('l-pass').value;
            if(e && p) auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('auth-msg').innerText = err.message);
        }

        function emailRegister() {
            const n = document.getElementById('r-name').value;
            const e = document.getElementById('r-email').value;
            const p = document.getElementById('r-pass').value;
            if(n && e && p) {
                auth.createUserWithEmailAndPassword(e, p).then(cred => {
                    createUserEntry(cred.user, n);
                }).catch(err => document.getElementById('auth-msg').innerText = err.message);
            }
        }

        function googleLogin() {
            const p = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(p).catch(err => document.getElementById('auth-msg').innerText = err.message);
        }

        function createUserEntry(user, name) {
            db.ref('users/' + user.uid).set({
                name: name || user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                activeDeviceId: HWID,
                subscriptionType: 'trial',
                accessExpiry: Date.now() + (10 * 60 * 1000), // 10 Min Trial
                isBlocked: false
            });
        }

        function checkUserDB(user) {
            db.ref('users/' + user.uid).on('value', s => {
                userData = s.val();
                if(!userData) { createUserEntry(user, null); return; }

                // G: Device Lock
                if(userData.activeDeviceId && userData.activeDeviceId !== HWID) {
                    alert("Account locked to another device!");
                    auth.signOut();
                    return;
                }
                if(!userData.activeDeviceId) db.ref('users/' + user.uid).update({ activeDeviceId: HWID });

                // A: Block
                if(userData.isBlocked) { alert("Account Banned!"); auth.signOut(); return; }

                // Success
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                updateProfileUI();
                loadContent();
            });
        }

        // --- CONTENT & FEATURES ---
        function loadContent() {
            // Load Channels
            db.ref('channels').on('value', s => {
                const g = document.getElementById('channels-grid'); g.innerHTML='';
                s.forEach(c => {
                    const d = c.val();
                    const card = createCard(d, c.key, 'channel');
                    g.appendChild(card);
                });
            });

            // Load Movies
            db.ref('movies').on('value', s => {
                const g = document.getElementById('movies-grid'); g.innerHTML='';
                const movies = [];
                s.forEach(m => movies.push(m.val()));
                movies.reverse().forEach((d, i) => {
                    if(i===0) document.getElementById('banner-img').src = d.backdropURL || d.posterURL;
                    const card = createCard(d, i, 'movie');
                    g.appendChild(card);
                });
            });

            // Load Stories & Tech
            db.ref('stories').on('value', s => {
                const l = document.getElementById('stories-list'); l.innerHTML='';
                s.forEach(st => {
                    const d = st.val();
                    l.innerHTML += `<div class="book-item" onclick='openReader(${JSON.stringify(d)})'><div><b>${d.title}</b><br><small>${d.author}</small></div><i class="fas fa-chevron-right"></i></div>`;
                });
            });
            
            db.ref('techUpdates').on('value', s => {
                const l = document.getElementById('tech-list'); l.innerHTML='';
                s.forEach(t => {
                    const d = t.val();
                    l.innerHTML += `<div class="book-item" onclick='openReader(${JSON.stringify(d)})'><div><b>${d.title}</b></div><i class="fas fa-chevron-right"></i></div>`;
                });
            });

            // Downloads (Existing)
            db.ref('downloadableMovies').on('value', s => {
                const l = document.getElementById('downloads-list'); l.innerHTML='';
                s.forEach(d => {
                    const v = d.val();
                    l.innerHTML += `<div class="book-item" onclick="window.open('${v.downloadURL}')"><div><b>${v.title}</b></div><i class="fas fa-download"></i></div>`;
                });
            });

            // Chat
            db.ref('chatRoom').limitToLast(50).on('child_added', s => {
                const m = s.val();
                const div = document.createElement('div');
                div.className = `chat-msg ${m.uid === currentUser.uid ? 'msg-me' : 'msg-other'}`;
                div.innerHTML = `<span class="msg-name">${m.name}</span>${m.text}`;
                const list = document.getElementById('chat-messages');
                list.appendChild(div);
                list.scrollTop = list.scrollHeight;
            });

            // Settings & Inject
            db.ref('settings').on('value', s => {
                const set = s.val();
                if(set) {
                    adminNumber = set.adminContactNumber;
                    document.getElementById('wa-link').href = `https://wa.me/${adminNumber}`;
                    if(set.injectedCode) {
                        const container = document.getElementById('injected-code');
                        container.innerHTML = set.injectedCode;
                        Array.from(container.querySelectorAll("script")).forEach( oldScript => {
                            const newScript = document.createElement("script");
                            Array.from(oldScript.attributes).forEach( attr => newScript.setAttribute(attr.name, attr.value) );
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }
                }
            });
        }

        function createCard(data, key, type) {
            const isVip = data.access === 'VIP';
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <span class="badge ${isVip ? 'badge-vip' : 'badge-free'}">${isVip ? 'VIP' : 'FREE'}</span>
                <img src="${type==='channel'?data.logo:data.posterURL}">
                <div class="card-overlay"><div class="card-title">${type==='channel'?data.name:data.title}</div></div>
            `;
            div.onclick = () => handleAccess(data);
            return div;
        }

        function handleAccess(data) {
            // E: Check Access
            const isVip = data.access === 'VIP';
            const isSub = userData.subscriptionType === 'premium' && userData.accessExpiry > Date.now();
            const isTrial = userData.subscriptionType === 'trial' && userData.accessExpiry > Date.now();

            if(isVip && !isSub) {
                // H: Token System
                const token = prompt("ðŸ”’ VIP Content. Enter Token to Unlock:");
                if(token) verifyToken(token, data);
                return;
            }

            // L: Ads for non-premium
            if(!isSub) {
                showAd(() => playContent(data));
            } else {
                playContent(data);
            }
        }

        function verifyToken(token, data) {
            db.ref('tokens').orderByChild('token').equalTo(token).once('value', s => {
                let valid = false;
                s.forEach(t => {
                    const info = t.val();
                    if(info.status === 'ACTIVE' && (info.hwid === 'ANY' || info.hwid === HWID)) {
                        valid = true;
                        db.ref('tokens/'+t.key).update({status: 'USED', usedBy: currentUser.uid});
                        db.ref('users/'+currentUser.uid).update({
                            subscriptionType: 'premium',
                            accessExpiry: Date.now() + (info.duration * 86400000)
                        });
                        alert("Premium Activated!");
                        playContent(data);
                    }
                });
                if(!valid) alert("Invalid Token");
            });
        }

        // --- PLAYER (F: SHAKA DRM) ---
        function initShaka() {
            shaka.polyfill.installAll();
            if(shaka.Player.isBrowserSupported()) {
                shakaPlayer = new shaka.Player(document.getElementById('video'));
            }
        }

        function playContent(data) {
            const url = data.stream || data.movieURL;
            document.getElementById('player-modal').style.display = 'flex';
            
            let config = {};
            if(data.drmKey && data.drmId) {
                config = { drm: { clearKeys: { [data.drmId]: data.drmKey } } };
            } else if(data.license) {
                config = { drm: { servers: { 'com.widevine.alpha': data.license } } };
            }
            
            shakaPlayer.configure(config);
            shakaPlayer.load(url).catch(e => console.error(e));
        }

        function closePlayer() {
            shakaPlayer.unload();
            document.getElementById('player-modal').style.display = 'none';
        }

        // --- EXTRAS ---
        function showAd(cb) {
            db.ref('ads').limitToLast(1).once('value', s => {
                let ad = null; s.forEach(a => ad = a.val());
                if(ad) {
                    document.getElementById('ad-img').src = ad.image;
                    document.getElementById('ad-overlay').style.display = 'flex';
                    currentAd = ad;
                    let t = parseInt(ad.duration) || 15;
                    const timer = document.getElementById('ad-timer');
                    const skip = document.getElementById('ad-skip');
                    const int = setInterval(() => {
                        t--; timer.innerText = t;
                        if(t <= 0) { clearInterval(int); skip.style.display = 'block'; skip.onclick = () => { document.getElementById('ad-overlay').style.display='none'; cb(); }; }
                    }, 1000);
                } else { cb(); }
            });
        }
        function openAd() { if(currentAd) window.open(currentAd.link); }

        function sendChat() {
            const txt = document.getElementById('chat-input').value;
            if(txt) {
                db.ref('chatRoom').push({ text: txt, name: userData.name, uid: currentUser.uid, timestamp: Date.now() });
                document.getElementById('chat-input').value = "";
            }
        }

        function openReader(data) {
            document.getElementById('read-title').innerText = data.title;
            document.getElementById('read-content').innerHTML = data.content;
            document.getElementById('reader-modal').style.display = 'block';
        }

        // UI UTILS
        function switchTab(id, el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            ['home','chat','library','notif'].forEach(v => document.getElementById('view-'+v).style.display='none');
            document.getElementById('view-'+id).style.display = id === 'chat' ? 'flex' : 'block';
            document.getElementById('side-menu').classList.remove('open');
        }
        function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
        function openPage(id) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            ['home','chat','library','notif'].forEach(v => document.getElementById('view-'+v).style.display='none');
            document.getElementById('view-'+id).style.display='block';
            document.getElementById('side-menu').classList.remove('open');
        }

        function updateProfileUI() {
            document.getElementById('p-name').innerText = userData.name;
            document.getElementById('p-email').innerText = userData.email;
            document.getElementById('p-hwid').innerText = HWID;
            document.getElementById('header-pic').src = userData.photoURL || 'https://via.placeholder.com/50';
            document.getElementById('p-img').src = userData.photoURL || 'https://via.placeholder.com/80';
            const exp = new Date(userData.accessExpiry).toLocaleDateString();
            document.getElementById('p-sub').innerText = `${userData.subscriptionType.toUpperCase()} (Exp: ${exp})`;
        }
        function openProfile() { document.getElementById('profile-modal').style.display='flex'; }
        function copyHwid() { navigator.clipboard.writeText(HWID); alert("Copied ID!"); }
        
        function sendRequest() {
            const txt = document.getElementById('req-text').value;
            if(txt) {
                db.ref('requests').push({ user: userData.name, text: txt, uid: currentUser.uid });
                alert("Sent!");
            }
        }

    </script>
</body>
</html>
